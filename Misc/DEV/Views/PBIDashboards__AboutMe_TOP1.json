{"name":"PBIDashboards::AboutMe_TOP1","category":"view","description":"MRN and Completion Date of About Me from the last X days (parameter, or if null defaults to 30) (DEPRECATED) (10-12-2020)","metaData":"{\r\n    \"parameters\": [\r\n        {\r\n            \"name\": \"last_x_days\",\r\n            \"description\": \"The last X days to show, or 30 if null\",\r\n            \"type\": \"string\"\r\n        }\r\n    ]\r\n}","steps":[{"processorName":"js","processorData":"// v1.0.0 - Haydn Williams original\r\n// DEPRECATED see PBIDashboards::AboutMe\r\n\r\nvar replaceMe = \"<replace>\";\r\n\r\nvar aql = \"SELECT c/uid/value as cuid, \" +\r\n       \"c/context/start_time/value as completed, \" +\r\n       \"e/ehr_status/subject/external_ref/id/value as mrn, \" +\r\n       \"SQUASH(g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Communication']/items[at0009]/items[at0013]/value/value) as com_assessment_findings, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Communication']/items[at0009]/items[at0011]/value/value as com_assessment_other, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Communication']/items[at0015]/items[at0045]/value/value as con_action_comment, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Personal Hygiene']/items[at0009]/items[at0013]/value/value as hyg_assessment_finding, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Personal Hygiene']/items[at0009]/items[at0011]/value/value as hyg_assessment_other, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Personal Hygiene']/items[at0009]/items[at0012]/value/value as hyg_assessment_comment, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Personal Hygiene']/items[at0015]/items[at0027,'Package of Care - Frequency']/value/value as hyg_action_package, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Personal Hygiene']/items[at0015]/items[at0027,'Assistance Of']/value/value as hyg_action_assisstance, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Personal Hygiene']/items[at0015]/items[at0045]/value/value as hyg_action_comment, \" +\r\n       \"SQUASH(g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Nutrition and Hydration']/items[at0009]/items[at0013]/value/value) as nut_assessment_findings, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Nutrition and Hydration']/items[at0009]/items[at0013,'Diabetes Type']/value/value as nut_assessment_diabetes, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Nutrition and Hydration']/items[at0009]/items[at0011]/value/value as nut_assessment_other, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Nutrition and Hydration']/items[at0009]/items[at0012]/value/value as nut_assessment_comment, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Nutrition and Hydration']/items[at0015]/items[at0027,'IDDSI Diet Levels']/value/value as nut_action_diet, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Nutrition and Hydration']/items[at0015]/items[at0027,'IDDSI Fluid Levels']/value/value as nut_action_fluid, \" +\r\n       \"SQUASH(g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Nutrition and Hydration']/items[at0015]/items[at0027, 'Actions']/value/value) as nut_action_actions, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Nutrition and Hydration']/items[at0015]/items[at0045]/value/value as nut_action_comment, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Sleep and Rest']/items[at0009]/items[at0013]/value/value as sleep_assessment_finding, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Sleep and Rest']/items[at0009]/items[at0011]/value/value as sleep_assessment_other, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Sleep and Rest']/items[at0009]/items[at0012]/value/value as sleep_assessment_comment, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Sleep and Rest']/items[at0015]/items[at0027]/value/value as sleep_action_action, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Sleep and Rest']/items[at0015]/items[at0045]/value/value as sleep_action_comment, \" +\r\n       \"SQUASH(g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Elimination']/items[at0009]/items[at0013]/value/value) as elim_assessment_findings, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Elimination']/items[at0009]/items[at0011]/value/value as elim_assessment_other, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Elimination']/items[at0009]/items[at0012]/value/value as elim_assessment_comment, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Elimination']/items[at0015]/items[at0027]/value/value as elim_action_actions, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Elimination']/items[at0015]/items[at0045]/value/value as elim_action_comment, \" +\r\n       \"SQUASH(g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Pain']/items[at0009]/items[at0013]/value/value) as pain_assessment_findings, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Pain']/items[at0009]/items[at0011]/value/value as pain_assessment_other, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Pain']/items[at0009]/items[at0012]/value/value as pain_assessment_comment, \" +\r\n       \"SQUASH(g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Pain']/items[at0015]/items[at0027]/value/value) as pain_action_actions, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Pain']/items[at0015]/items[at0045]/value/value as pain_action_comment, \" +\r\n       \"SQUASH(g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Breathing and Circulation']/items[at0009]/items[at0013]/value/value) as breath_assessment_findings, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Breathing and Circulation']/items[at0009]/items[at0011]/value/value as breath_assessment_other, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Breathing and Circulation']/items[at0009]/items[at0012]/value/value as breath_assessment_comment, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Breathing and Circulation']/items[at0015]/items[at0027]/value/value as breath_action_action, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Breathing and Circulation']/items[at0015]/items[at0045]/value/value as breath_action_comment \" +\r\n\"FROM EHR e \" +\r\n\"CONTAINS top 1 COMPOSITION c[openEHR-EHR-COMPOSITION.encounter.v1] \" +\r\n\"CONTAINS EVALUATION g[openEHR-EHR-EVALUATION.generic_assessment_collection.v0] \" +\r\n\"WHERE c/name/value = 'About Me' \" +\r\n    \"AND completed > '\" + replaceMe + \"' \" +\r\n\t\"ORDER BY c/context/start_time/value DESC \" +\r\n\t\"LIMIT 1000\";\r\n\r\n\r\nvar test_aql = \"SELECT c/uid/value as cuid, \" +\r\n       \"c/context/start_time/value as completed, \" +\r\n       \"e/ehr_status/subject/external_ref/id/value as mrn, \" +\r\n\t   \"SQUASH(g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Communication']/items[at0009]/items[at0013]/value/value) as com_assessment_findings, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Personal Hygiene']/items[at0009]/items[at0013]/value/value as hyg_assessment_finding, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Personal Hygiene']/items[at0009]/items[at0012]/value/value as hyg_assessment_comment, \" +\r\n\t   \"SQUASH(g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Nutrition and Hydration']/items[at0009]/items[at0013]/value/value) as nut_assessment_findings, \" +\r\n\t   \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Nutrition and Hydration']/items[at0009]/items[at0012]/value/value as nut_assessment_comment \" +\r\n\"FROM EHR e \" +\r\n\"CONTAINS COMPOSITION c[openEHR-EHR-COMPOSITION.encounter.v1] \" +\r\n\"CONTAINS EVALUATION g[openEHR-EHR-EVALUATION.generic_assessment_collection.v0] \" +\r\n\"WHERE c/name/value = 'About Me' \" +\r\n    \"AND completed > '2020-08-11T10:00:00+01:00' \" +\r\n\t\"ORDER BY c/context/start_time/value DESC \" +\r\n\t\"LIMIT 1000\";\r\n\t\r\nvar test_aql2 = \"SELECT c/uid/value as cuid, \" +\r\n       \"c/context/start_time/value as completed, \" +\r\n       \"e/ehr_status/subject/external_ref/id/value as mrn, \" +\r\n\t   \"SQUASH(g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Communication']) as communication, \" +\r\n       \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Personal Hygiene'] as personal, \" +\r\n\t   \"g/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Nutrition and Hydration'] as nutrition \" +\r\n\"FROM EHR e \" +\r\n\"CONTAINS COMPOSITION c[openEHR-EHR-COMPOSITION.encounter.v1] \" +\r\n\"CONTAINS EVALUATION g[openEHR-EHR-EVALUATION.generic_assessment_collection.v0] \" +\r\n\"WHERE c/name/value = 'About Me' \" +\r\n    \"AND completed > '2020-08-11T10:00:00+01:00' \" +\r\n\t\"ORDER BY c/context/start_time/value DESC \" +\r\n\t\"LIMIT 1000\";\r\n\t\r\nvar only_completed = \"SELECT c/uid/value as cuid, \" +\r\n       \"c/context/start_time/value as completed, \" +\r\n       \"e/ehr_status/subject/external_ref/id/value as mrn \" +\r\n\"FROM EHR e \" +\r\n\"CONTAINS Top 1 COMPOSITION c[openEHR-EHR-COMPOSITION.encounter.v1] \" +\r\n\"WHERE c/name/value = 'About Me' \" +\r\n    \"AND completed > '\" + replaceMe + \"' \" +\r\n\t\"ORDER BY c/context/start_time/value DESC \" +\r\n\t\"LIMIT 1000\";\r\n\t\r\n\r\nfunction compute(ctx, src) {\r\n\tvar x = ctx.vars.last_x_days;\r\n\tif(!x || x == \"\") {\r\n\t\tx = ctx.vars.last_x_days = 30;\r\n\t}\r\n\r\n\tvar d = new Date();\r\n\tvar theLongLongAgo = new Date(d.setDate(d.getDate() - x));\r\n\tctx.vars.from_date = theLongLongAgo.toISOString();\r\n\t\r\n\tvar query = aql.replace(replaceMe, ctx.vars.from_date);\r\n\t\r\n\tvar promises = {\r\n        forms: Ehr.query({\r\n\t\t\taql: query,\r\n\t\t\tparams: ctx.vars,\r\n\t\t\tinitvalue: [],\r\n\t\t\tcallback: function (out, form) {\r\n\t\t\t\tout.push({\r\n\t\t\t\t\t\t\"form_name\": \"About Me\",\r\n\t\t\t\t\t\t\"form_id\": form.cuid,\r\n\t\t\t\t\t\t\"recorded_date\": form.completed,\r\n\t\t\t\t\t\t\"patient_mrn\": form.mrn,\r\n\t\t\t\t\t\t\"communication\": {\r\n\t\t\t\t\t\t\t\"assessment\": {\r\n\t\t\t\t\t\t\t\t\"findings\": form.com_assessment_findings,\r\n\t\t\t\t\t\t\t\t\"other\": form.com_assessment_other\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\"action\": {\r\n\t\t\t\t\t\t\t\t\"comment\": form.con_action_comment\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\"personal_hygiene\": {\r\n\t\t\t\t\t\t\t\"assessment\": {\r\n\t\t\t\t\t\t\t\t\"findings\": form.hyg_assessment_finding,\r\n\t\t\t\t\t\t\t\t\"other\": form.hyg_assessment_other,\r\n\t\t\t\t\t\t\t\t\"comment\": form.hyg_assessment_comment\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\"action\": {\r\n\t\t\t\t\t\t\t\t\"package_of_care\": form.hyg_action_package,\r\n\t\t\t\t\t\t\t\t\"assistance_of\": form.hyg_action_assisstance,\r\n\t\t\t\t\t\t\t\t\"comment\": form.hyg_action_comment\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\"nutrition_and_hydration\": {\r\n\t\t\t\t\t\t\t\"assessment\": {\r\n\t\t\t\t\t\t\t\t\"findings\": form.nut_assessment_findings,\r\n\t\t\t\t\t\t\t\t\"diabetes_type\": form.nut_assessment_diabetes,\r\n\t\t\t\t\t\t\t\t\"other\": form.nut_assessment_other,\r\n\t\t\t\t\t\t\t\t\"comment\": form.nut_assessment_comment\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\"action\": {\r\n\t\t\t\t\t\t\t\t\"diet_levels\": form.nut_action_diet,\r\n\t\t\t\t\t\t\t\t\"fluid_levels\": form.nut_action_fluid,\r\n\t\t\t\t\t\t\t\t\"actions\": form.nut_action_actions,\r\n\t\t\t\t\t\t\t\t\"comment\": form.nut_action_comment\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\"sleep_and_rest\": {\r\n\t\t\t\t\t\t\t\"assessment\": {\r\n\t\t\t\t\t\t\t\t\"findings\": form.sleep_assessment_finding,\r\n\t\t\t\t\t\t\t\t\"other\": form.sleep_assessment_other,\r\n\t\t\t\t\t\t\t\t\"comment\": form.sleep_assessment_comment\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\"action\": {\r\n\t\t\t\t\t\t\t\t\"actions\": form.sleep_action_action,\r\n\t\t\t\t\t\t\t\t\"comment\": form.sleep_action_comment\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\"elimination\": {\r\n\t\t\t\t\t\t\t\"assessment\": {\r\n\t\t\t\t\t\t\t\t\"findings\": form.elim_assessment_findings,\r\n\t\t\t\t\t\t\t\t\"other\": form.elim_assessment_other,\r\n\t\t\t\t\t\t\t\t\"comment\": form.elim_assessment_comment\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\"action\": {\r\n\t\t\t\t\t\t\t\t\"actions\": form.elim_action_actions,\r\n\t\t\t\t\t\t\t\t\"comment\": form.elim_action_comment\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\"pain\": {\r\n\t\t\t\t\t\t\t\"assessment\": {\r\n\t\t\t\t\t\t\t\t\"findings\": form.pain_assessment_findings,\r\n\t\t\t\t\t\t\t\t\"other\": form.pain_assessment_other,\r\n\t\t\t\t\t\t\t\t\"comment\": form.pain_assessment_comment\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\"action\": {\r\n\t\t\t\t\t\t\t\t\"actions\": form.pain_action_actions,\r\n\t\t\t\t\t\t\t\t\"comment\": form.pain_action_comment\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\"breathing_and_circulation\": {\r\n\t\t\t\t\t\t\t\"assessment\": {\r\n\t\t\t\t\t\t\t\t\"findings\": form.breath_assessment_findings,\r\n\t\t\t\t\t\t\t\t\"other\": form.breath_assessment_other,\r\n\t\t\t\t\t\t\t\t\"comment\": form.breath_assessment_comment\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\"action\": {\r\n\t\t\t\t\t\t\t\t\"actions\": form.breath_action_action,\r\n\t\t\t\t\t\t\t\t\"comment\": form.breath_action_comment\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t})\r\n\t};\r\n\r\n    var result = {};\r\n\ttry {\r\n\t\tEhr.allhash(promises, function (res) {\r\n\t\t\tresult = res['forms'];\r\n\t\t\tresult.params = res['params'];\r\n\t\t});\r\n\t} catch(ex) {\r\n\t\tresult = {\r\n\t\t\texception: ex\r\n\t\t};\r\n\t}\r\n    \r\n    return result;\r\n}\r\n"}]}
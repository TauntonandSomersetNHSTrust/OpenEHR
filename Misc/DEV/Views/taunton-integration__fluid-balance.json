{"name":"taunton-integration::fluid-balance","category":"view","description":"fluid balance section","metaData":"{\r\n    \"parameters\": [\r\n        {\r\n            \"name\": \"ehrId\",\r\n            \"description\": \"Ehr id\",\r\n            \"type\": \"string\"\r\n        },\r\n        {\r\n            \"name\": \"dateFrom\",\r\n            \"description\": \"Date from\",\r\n            \"type\": \"string\"\r\n        },\r\n        {\r\n            \"name\": \"dateTo\",\r\n            \"description\": \"Date to\",\r\n            \"type\": \"string\"\r\n        }\r\n    ]\r\n}","steps":[{"processorName":"js","processorData":"// Fluid Balance Widget Section View v1.1.0\r\n// Template required: NHS Somerset - eObservations & NEWS2 1.0.0\r\n// Authors: Tomaz Kenda (tomaz.kenda@better.care), Vanessa Pereira (vanessa.pereira@better.care)\r\n\r\n\r\nfunction compute(ctx, src) {\r\n    var promises = {\r\n        fluid_chart: Ehr.query({\r\n            aql: \"SELECT \" +\r\n                \"a_i/data[at0001]/events[at0002]/data[at0003]/items[at0004]/value/value as balanceFluidChart, \" +\r\n                \"a_i/data[at0001]/events[at0002]/time/value as balanceFluidChartTime, \" +\r\n                \"a/name/value as templateName, \" +\r\n                \"a/archetype_details/template_id/value as templateId, \" +\r\n                \"a/uid/value as compositionUid, \" +\r\n                \"a/context/start_time/value as dateCompositionSubmitted, \" +\r\n                \"a/composer/name as composer \\n\" +\r\n            \"FROM EHR e[ehr_id/value=:ehrId] \\n \" +\r\n            \"CONTAINS COMPOSITION a \\n\" +\r\n            \"CONTAINS OBSERVATION a_i[openEHR-EHR-OBSERVATION.fluid_balance_chart_checklist.v0] \\n\" +\r\n            \"WHERE \\n\" +\r\n            \"templateId = 'NHS Somerset - eObservations & NEWS2' \\n\" +\r\n          (typeof (ctx.vars.dateFrom) === \"undefined\" || ctx.vars.dateFrom === null ?  '' : '    AND dateCompositionSubmitted >= :dateFrom') +\r\n            (typeof (ctx.vars.dateTo) === \"undefined\" || ctx.vars.dateTo === null ? '' : '    AND dateCompositionSubmitted <= :dateTo') +\r\n                \"\\n\"+\r\n            \"ORDER BY dateCompositionSubmitted DESC \\n\" +\r\n            \"offset 0 limit 100 \\n\",\r\n            initvalue: [],\r\n                params: ctx.vars,\r\n             callback: function(out, result) {\r\n                out.push(result);\r\n            }\r\n        })\r\n    };\r\n\r\n    function evaluate(assessment) {\r\n         if (assessment) {\r\n            if (assessment.balanceFluidChart === null || assessment.balanceFluidChart === undefined) {\r\n                return null;\r\n            }\r\n            var evaluatedValue;\r\n            evaluatedValue = assessment.balanceFluidChart ? 'Yes' : 'No';\r\n            return {\r\n                'compositionUid': (assessment.compositionUid.split(\"::\"))[0],\r\n                'value': evaluatedValue,\r\n                'class': null,\r\n                'date': assessment.balanceFluidChartTime || assessment.dateCompositionSubmitted\r\n            };\r\n        }\r\n    }\r\n\r\n    var latestValue;\r\n    Ehr.allhash(promises, function (res) {\r\n        if (res['fluid_chart'] != undefined && res['fluid_chart'].length != 0)  {\r\n            if (res['fluid_chart'].length) {\r\n                latestValue = evaluate(res['fluid_chart'][0]);\r\n            } else {\r\n                latestValue = evaluate(res['fluid_chart']);\r\n            }\r\n        }\r\n    });\r\n\r\n    return latestValue ? {\r\n        'widgetType': 'RISK_STAGE',    // RISK_STAGE | LIST_OF_FORMS | SINGLE_PARAMETER;\r\n        'riskStageType': 'SCORE',\r\n        'titleShort': 'Fluid balance chart',\r\n        'titleLong': 'Fluid balance chart',\r\n        'iconSrc': null,\r\n        'moreButtonUrl': null,\r\n        'clickUrl': null,\r\n        'latestValue': latestValue,\r\n    } : null;\r\n}"}]}
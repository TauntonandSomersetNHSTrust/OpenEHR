{"name":"taunton-integration::fluid-balance","category":"view","description":null,"metaData":"{\n    \"parameters\": []\n}","steps":[{"processorName":"js","processorData":"function compute(ctx, src) {\n    var promises = {\n        fluid_chart: Ehr.query({\n            aql: 'SELECT ' +\n                'a_i/data[at0001]/events[at0002]/data[at0003]/items[at0004]/value/value as balanceFluidChart, ' +\n                'a_i/data[at0001]/events[at0002]/time/value as balanceFluidChartTime, ' +\n                'a/name/value as templateName, ' +\n                'a/archetype_details/template_id/value as templateId, ' +\n                'a/uid/value as compositionUid, ' +\n                'a/context/start_time/value as dateCompositionSubmitted, ' +\n                'a/composer/name as composer \\n' +\n            'FROM EHR e[ehr_id/value=:ehrId] \\n ' +\n            'CONTAINS COMPOSITION a \\n' +\n            'CONTAINS OBSERVATION a_i[openEHR-EHR-OBSERVATION.fluid_balance_chart_checklist.v0] \\n' +\n            'ORDER BY dateCompositionSubmitted DESC \\n' +\n            'offset 0 limit 100 \\n',\n            initvalue: [],\n            params: {\n              ehrId: ctx.vars.ehrId,\n            },\n            callback: function(out, result) {\n                out.push(result);\n            }\n        })\n    };\n\n    function evaluate(assessment) {\n         if (assessment) {\n            if (assessment.balanceFluidChart === null || assessment.balanceFluidChart === undefined) {\n                return null;\n            }\n            var evaluatedValue;\n            evaluatedValue = assessment.balanceFluidChart ? 'Yes' : 'No';\n            return {\n                'compositionUid': (assessment.compositionUid.split(\"::\"))[0],\n                'value': evaluatedValue,\n                'class': null,\n                'date': assessment.balanceFluidChartTime || assessment.dateCompositionSubmitted\n            };\n        }\n    }\n\n    var latestValue;\n    Ehr.allhash(promises, function (res) {\n        if (res['fluid_chart'] != undefined && res['fluid_chart'].length != 0)  {\n            if (res['fluid_chart'].length) {\n                latestValue = evaluate(res['fluid_chart'][0]);\n            } else {\n                latestValue = evaluate(res['fluid_chart']);\n            }\n        }\n    });\n\n    return latestValue ? {\n        'widgetType': 'RISK_STAGE',    // RISK_STAGE | LIST_OF_FORMS | SINGLE_PARAMETER;\n        'riskStageType': 'SCORE',\n        'titleShort': 'Fluid balance chart',\n        'titleLong': 'Fluid balance chart',\n        'iconSrc': null,\n        'moreButtonUrl': null,\n        'clickUrl': null,\n        'latestValue': latestValue,\n    } : null;\n}"}]}
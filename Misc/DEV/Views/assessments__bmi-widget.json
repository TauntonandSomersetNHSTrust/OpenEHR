{"name":"assessments::bmi-widget","category":"view","description":"BMI Widget","metaData":"{\r\n    \"parameters\": [\r\n        {\r\n            \"name\": \"ehrId\",\r\n            \"description\": \"Ehr id\",\r\n            \"type\": \"string\"\r\n        }\r\n    ]\r\n}","steps":[{"processorName":"js","processorData":"// Assessments BMI Widget View v1.0.2\r\n// Template required: /\r\n//@vanessap: view updated to 1.0.2. Will accept BMI values from any composition that has the BMI archetype.\r\n\r\nfunction compute(ctx, src)\r\n{\r\n    var promises = {\r\n        BMI: Ehr.query({\r\n            aql: \"select\\n\"+\r\n            \"    a/context/start_time/value as dateCompositionSubmitted,\\n\"+\r\n            \"    a/composer/name as creator,\\n\"+\r\n            \"    a/composer/external_ref/id/value as creatorId,\\n\"+\r\n            \"    a_b/data[at0001]/events[at0002]/data[at0003]/items[at0004]/value/magnitude as bmiValueMagnitude,\\n\"+\r\n            \"    a_b/data[at0001]/events[at0002]/data[at0003]/items[at0004]/value/units as bmiValueUnits,\\n\"+\r\n            \"    a/name/value as templateName,\\n\"+\r\n            \"    a/archetype_details/template_id/value as templateId,\\n\"+\r\n            \"    a/uid/value as compositionUid  \\n\"+\r\n            \"from EHR e [ehr_id/value=:ehrId]\\n\"+\r\n            \"contains COMPOSITION a\\n\"+\r\n            \"contains OBSERVATION a_b[openEHR-EHR-OBSERVATION.body_mass_index.v2]\\n\"+\r\n            \"order by dateCompositionSubmitted desc\\n\"+ \r\n            \"limit 8\",\r\n            initvalue: [],\r\n            params: {\r\n              ehrId: ctx.vars.ehrId,\r\n            },\r\n            callback: function(out, result) {\r\n                out.push(result);\r\n            }\r\n        })\r\n    };\r\n\r\n    function evaluate(assessment, prevAssessment) {\r\n        var riskClass, riskText, referenceRange, trendIcon;\r\n\r\n        if (assessment.bmiValueMagnitude < 18.5) {\r\n            riskClass = \"hr\";\r\n            // riskText = \"Underweight\";\r\n            // referenceRange = '< 18.5';\r\n        } else if (assessment.bmiValueMagnitude < 25) {\r\n            riskClass = \"lr\";\r\n            // riskText = \"Average\";\r\n            // referenceRange = '18.5 - 24.9';\r\n        } else if (assessment.bmiValueMagnitude < 30) {\r\n            riskClass = \"lmr\";\r\n            // riskText = \"Overweight\";\r\n            // referenceRange = '25 - 29.9';\r\n        } else {\r\n            riskClass = \"hr\";\r\n            // riskText = \"Obese\";\r\n            // referenceRange = '>= 30';\r\n        }\r\n        if (prevAssessment && prevAssessment.bmiValueMagnitude && assessment.bmiValueMagnitude !== prevAssessment.bmiValueMagnitude) {\r\n            trendIcon = assessment.bmiValueMagnitude > prevAssessment.bmiValueMagnitude ? 'trend-up' : 'trend-down';\r\n        }\r\n        return {\r\n            'compositionUid': (assessment.compositionUid.split(\"::\"))[0],\r\n            'value': assessment.bmiValueMagnitude,\r\n            'date': assessment.dateCompositionSubmitted,\r\n            'composer': assessment.creator,\r\n            'unit': 'kg/mÂ²',\r\n            'icon': trendIcon,\r\n            // 'dateCreated': assessment.dateCompositionSubmitted,\r\n            // 'dateUpdated': assessment.dateTime,\r\n            'class': riskClass,\r\n            'riskText': riskText,\r\n        };\r\n    }\r\n\r\n    var latestValue;\r\n    var historicValues = [];\r\n    Ehr.allhash(promises, function(res) {\r\n        if (res['BMI'] == null || res['BMI'].length == 0) {\r\n            latestValue = null;\r\n        } else {\r\n             if (res['BMI'].length > 1) {\r\n                latestValue = evaluate(res['BMI'][0], res['BMI'][1]);\r\n            } else {\r\n                latestValue = evaluate(res['BMI'][0]);\r\n            }\r\n            // res['BMI'].shift();\r\n            historicValues = res['BMI'];\r\n            historicValues = historicValues.map(function(historicVal, index) {\r\n            return evaluate(historicVal);\r\n            }).slice(0, 6); // Wrap this in try-catch\r\n        }\r\n    });\r\n\r\n    var moreButtonUrl = null;\r\n    var clickUrl = null;\r\n    if (latestValue != null) {\r\n        moreButtonUrl = {\r\n            'path': 'timeline/assessments::must-timeline,assessments::waterlow-timeline',\r\n            'navigationType': 'PORTAL'\r\n        };\r\n        clickUrl = {\r\n            'path': '' + latestValue.compositionUid,\r\n            'navigationType': 'PORTAL'\r\n        };\r\n    }\r\n\r\n    return {\r\n        'widgetType': 'RISK_STAGE',                 // RISK_STAGE | LIST_OF_FORMS | SINGLE_PARAMETER;\r\n        'riskStageType': 'SCORE',                   // SCORE | ASSESSMENT\r\n        'titleShort': 'BMI',\r\n        'titleLong': 'Body Mass Index',\r\n        'iconSrc': null,\r\n        'moreButtonUrl': moreButtonUrl,\r\n        'clickUrl': clickUrl,\r\n        'latestValue': latestValue,\r\n        'historicValues': historicValues\r\n    }\r\n}\r\n"}]}
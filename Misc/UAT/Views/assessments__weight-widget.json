{"name":"assessments::weight-widget","category":"view","description":"Weight Assessment Widget","metaData":"{\r\n    \"parameters\": [\r\n        {\r\n            \"name\": \"ehrId\",\r\n            \"description\": \"Ehr id\",\r\n            \"type\": \"string\"\r\n        }\r\n    ]\r\n}","steps":[{"processorName":"js","processorData":"// Assessments Weight Widget View v1.0.1\r\n// Template required: /\r\n\r\nfunction compute(ctx, src)\r\n{\r\n    var promises = {\r\n        mustAssessment: Ehr.query({\r\n            aql: \"select\\n\"+\r\n            \"    a/context/start_time/value as dateCompositionSubmitted,\\n\"+\r\n            \"    a/composer/name as creator,\\n\"+\r\n            \"    a/composer/external_ref/id/value as creatorId,\\n\"+\r\n            \"    a/content[openEHR-EHR-OBSERVATION.body_weight.v2]/data[at0002]/events[at0003]/data[at0001]/items[at0004]/value/magnitude as bodyWeightMagnitude,\\n\"+\r\n            \"    a/content[openEHR-EHR-OBSERVATION.body_weight.v2]/data[at0002]/events[at0003]/data[at0001]/items[at0004]/value/units as bodyWeightUnit,\\n\"+\r\n            \"    a/name/value as templateName,\\n\"+\r\n            \"    a/archetype_details/template_id/value as templateId,\\n\"+\r\n            \"    a/uid/value as compositionUid   \\n\"+\r\n            \"from EHR e [ehr_id/value=:ehrId]\\n\"+\r\n            \"contains COMPOSITION a[openEHR-EHR-COMPOSITION.encounter.v1]\\n\"+\r\n            \"contains OBSERVATION a_a[openEHR-EHR-OBSERVATION.body_weight.v2]\\n\"+\r\n            // \"where a/name/value='Malnutrition universal screening tool'\\n\"+\r\n            \"order by dateCompositionSubmitted desc\\n\"+ \r\n            \"limit 8\",\r\n            initvalue: [],\r\n            params: {\r\n              ehrId: ctx.vars.ehrId,\r\n            },\r\n            callback: function(out, result) {\r\n                out.push(result);\r\n            }\r\n        })\r\n    };\r\n\r\n    function evaluate(assessment, prevAssessment) {\r\n        var riskClass, riskText, referenceRange, trendIcon;\r\n        if (prevAssessment && prevAssessment.bodyWeightMagnitude && assessment.bodyWeightMagnitude !== prevAssessment.bodyWeightMagnitude) {\r\n            trendIcon = assessment.bodyWeightMagnitude > prevAssessment.bodyWeightMagnitude ? 'trend-up' : 'trend-down';\r\n        }\r\n        return {\r\n            'compositionUid': (assessment.compositionUid.split(\"::\"))[0],\r\n            'value': assessment.bodyWeightMagnitude,\r\n            'unit': assessment.bodyWeightUnit,\r\n            'icon': trendIcon,\r\n            'date': assessment.dateCompositionSubmitted,\r\n            'composer': assessment.creator\r\n            // 'dateCreated': assessment.dateCompositionSubmitted,\r\n\r\n        };\r\n    }\r\n\r\n    var latestValue;\r\n    var historicValues = [];\r\n    Ehr.allhash(promises, function(res) {\r\n        if (res['mustAssessment'] == null || res['mustAssessment'].length == 0) {\r\n            latestValue = null;\r\n        } else {\r\n            if (res['mustAssessment'].length > 1) {\r\n                latestValue = evaluate(res['mustAssessment'][0], res['mustAssessment'][1]);\r\n            } else {\r\n                latestValue = evaluate(res['mustAssessment'][0]);\r\n            }\r\n            // res['mustAssessment'].shift();\r\n            historicValues = res['mustAssessment'];\r\n             historicValues = historicValues.map(function(historicVal, index) {\r\n                return evaluate(historicVal);\r\n            }).slice(0, 6); // Wrap this in try-catch\r\n        }\r\n    });\r\n\r\n    var moreButtonUrl = null;\r\n    var clickUrl = null;\r\n    if (latestValue != null) {\r\n        moreButtonUrl = {\r\n            'path': 'timeline/assessments::must-timeline,assessments::waterlow-timeline',\r\n            'navigationType': 'PORTAL'\r\n        };\r\n        clickUrl = {\r\n            'path': '' + latestValue.compositionUid,\r\n            'navigationType': 'PORTAL'\r\n        };\r\n    }\r\n\r\n\r\n    return {\r\n        'widgetType': 'SINGLE_PARAMETER',                 // RISK_STAGE | LIST_OF_FORMS | SINGLE_PARAMETER;\r\n        'titleShort': 'Weight',\r\n        'titleLong': 'Weight',\r\n        'iconSrc': null,\r\n        'moreButtonUrl': moreButtonUrl,\r\n        'clickUrl': clickUrl,\r\n        'latestValue': latestValue,\r\n        'historicValues': historicValues\r\n    }\r\n}\r\n"}]}
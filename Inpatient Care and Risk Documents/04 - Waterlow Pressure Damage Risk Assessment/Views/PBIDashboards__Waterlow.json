{"name":"PBIDashboards::Waterlow","category":"view","description":"Waterlow View For PowerBi Dashboards","metaData":null,"steps":[{"processorName":"js","processorData":"function subtractDays(date,days) {\r\n    return new Date(\r\n        date.getFullYear(),\r\n        date.getMonth(),\r\n        date.getDate() - days,\r\n        date.getHours(),\r\n        date.getMinutes(),\r\n        date.getSeconds(),\r\n        date.getMilliseconds()\r\n    );\r\n}\r\n\r\nfunction compute(ctx, src) {\r\n\r\nvar today = newÂ Date();\r\nvar datediff=subtractDays(today,30)\r\nvar datedifasstring=datediff.toISOString();\r\n\t\r\n\tvar promises = {\r\n        forms: Ehr.query({\r\n        aql:     \"select \\n\" + \r\n    \"a/name/value as formName, \\n\" + \r\n\t\"e/ehr_status/subject/external_ref/id/value as mrn, \\n\" + \r\n    \"a/context/start_time/value as created, \\n\" + \r\n    \"e/ehr_status/subject/external_ref/id/value as mrn, \\n\" + \r\n    \"b_b/data[at0002]/events[at0003]/data[at0001]/items[at0004]/value as Weight, \\n\" + \r\n    \"b_c/data[at0001]/events[at0002]/data[at0003]/items[at0004]/value as Height, \\n\" + \r\n    \"b_d/data[at0001]/events[at0002]/data[at0003]/items[at0004]/value as BMI, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0129]/items[at0054]/value/symbol as Nutritional_risk_Weight_loss, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0129]/items[at0044]/value/symbol as Nutritional_risk_Appetite, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0129]/items[at0130]/value as Nutritional_risk_Nutritional_score, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0116]/value/symbol as Skin_type_visual_risk_areas_Healthy, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0117]/value/symbol as Skin_type_visual_risk_areas_Tissue_paper, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0118]/value/symbol as Skin_type_visual_risk_areas_Dry, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0119]/value/symbol as Skin_type_visual_risk_areas_Oedematous, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0120]/value/symbol as Skin_type_visual_risk_areas_Clammy_pyrexia, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0121]/value/symbol as Skin_type_visual_risk_areas_Discoloured_Category_1, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0122]/value/symbol as Skin_type_visual_risk_areas_Pressure_ulcer_Stage_2_4, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0164]/value/symbol as Skin_type_visual_risk_areas_Broken_spots_Category_2_4, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0070]/items[at0123]/value/symbol as Tissue_malnutrition_Terminal_cachexia, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0070]/items[at0124]/value/symbol as Tissue_malnutrition_Single_organ_failure_respiratory_renal_cardiac_liver, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0070]/items[at0125]/value/symbol as Tissue_malnutrition_Multiple_organ_failure, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0070]/items[at0126]/value/symbol as Tissue_malnutrition_Peripheral_vascular_disease, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0070]/items[at0127]/value/symbol as Tissue_malnutrition_Anaemia, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0070]/items[at0128]/value/symbol as Tissue_malnutrition_Smoking, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0073]/items[at0150]/value/symbol as Neurological_deficit_Diabetes_MS_CVA, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0073]/items[at0151]/value/symbol as Neurological_deficit_Motor_sensory_deficit, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0073]/items[at0152]/value/symbol as Neurological_deficit_Paraplegia, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0073]/items[at0135]/value/symbol as Neurological_deficit_Combined_neurological_deficit, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0068]/items[at0114]/value/symbol as Major_surgery_or_trauma_Orthopaedic_spinal, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0068]/items[at0144]/value/symbol as Major_surgery_or_trauma_duration_of_surgery, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0068]/items[at0156]/value/symbol as Major_surgery_or_trauma_Major_Surgery_Or_Trauma_In_The_Last_48_Hours, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0067]/items[at0106]/value/symbol as Medication_Cytotoxics, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0067]/items[at0107]/value/symbol as Medication_Steroids, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0067]/items[at0108]/value/symbol as Medication_Anti_inflammatories, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0067]/items[at0140]/value/symbol as Medication_Combined_medication_risk, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0008]/value/Symbol as sex, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0009]/value/symbol as age_group, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0004]/value/symbol as Build_weight_for_height, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0005]/value/symbol as Continence, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0007]/value/symbol as Mobility, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0014]/value/magnitude as Waterlow_score, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0015]/value as Overall_risk_grade, \\n\" + \r\n    \"b_a/data[at0001]/events[at0002]/data[at0003]/items[at0019]/value as ScoringComment  \\n\" + \r\n\"from EHR e contains  \\n\" + \r\n\"top 1  \\n\" + \r\n\"COMPOSITION a[openEHR-EHR-COMPOSITION.encounter.v1]  \\n\" + \r\n\"contains ( \\n\" + \r\n    \"OBSERVATION b_a[openEHR-EHR-OBSERVATION.waterlow_score.v0] and \\n\" + \r\n    \"OBSERVATION b_b[openEHR-EHR-OBSERVATION.body_weight.v2] and \\n\" + \r\n    \"OBSERVATION b_c[openEHR-EHR-OBSERVATION.height.v2] and \\n\" + \r\n    \"OBSERVATION b_d[openEHR-EHR-OBSERVATION.body_mass_index.v2])  \\n\" + \r\n\"where a/name/value='Waterlow pressure damage risk assessment' and \\n\" +\r\n\"created > '\" +  datedifasstring + \"' \\n\" +\r\n\"order by created desc  \\n\" + \r\n\"offset 0 limit 100\",\r\n        params: ctx.vars,\r\n            initvalue: [],\r\n            callback: function (out, form) {\r\n                out.push(\r\n{\r\n\t\"formName\": form.formName,\r\n\t\"recordedDate\": form.created, \r\n\t\"PatientMRN\": form.mrn,\r\n\t\"NutritionalRisk\": { \r\n    \"Weight\": {\r\n\t\t\"magnitude\": form.Weight.magnitude, \r\n\t\t\"units\": form.Weight.units\r\n\t\t}, \r\n\t\"Height\": {\r\n\t\t\"magnitude\": form.Height.magnitude,\r\n\t\t\"units\": form.Height.units\r\n\t\t}, \r\n\t\"BMI\": {\r\n\t\t\"magnitude\": form.BMI.magnitude,\r\n\t\t\"units\": form.BMI.units\r\n\t\t},\r\n\t\"Build_weight_for_height\":form.Build_weight_for_height,\r\n\t\"WeightLossScore\": form.Nutritional_risk_Weight_loss\r\n\t},\r\n\r\n\"Skin_type\":{\r\n\t\"Skin_type_Healthy\": form.Skin_type_visual_risk_areas_Healthy,\r\n\t\"Skin_type_Tissue_paper\": form.Skin_type_visual_risk_areas_Tissue_paper,\r\n\t\"Skin_type_Dry\": form.Skin_type_visual_risk_areas_Dry,\r\n\t\"Skin_type_Oedematous\": form.Skin_type_visual_risk_areas_Oedematous,\r\n\t\"Skin_type_Clammy_pyrexia\": form.Skin_type_visual_risk_areas_Clammy_pyrexia,\r\n\t\"Skin_type_Discoloured_Category_1\": form.Skin_type_visual_risk_areas_Discoloured_Category_1,\r\n\t\"Skin_type_Pressure_ulcer_Stage_2_4\": form.Skin_type_visual_risk_areas_Pressure_ulcer_Stage_2_4,\r\n\t\"Skin_type_Broken_spots_Category_2_4\": form.Skin_type_visual_risk_areas_Broken_spots_Category_2_4\r\n\t},\r\n\r\n\"Tissue_malnutrition\":{\r\n\t\r\n\t\"Tissue_malnutrition_Terminal_cachexia\":form.Tissue_malnutrition_Terminal_cachexia, \r\n\t\"Tissue_malnutrition_Single_organ_failure_respiratory_renal_cardiac_liver\":form.Tissue_malnutrition_Single_organ_failure_respiratory_renal_cardiac_liver, \r\n\t\"Tissue_malnutrition_Multiple_organ_failure\":form.Tissue_malnutrition_Multiple_organ_failure, \r\n\t\"Tissue_malnutrition_Peripheral_vascular_disease\":form.Tissue_malnutrition_Peripheral_vascular_disease, \r\n    \"Tissue_malnutrition_Anaemia\":form.Tissue_malnutrition_Anaemia,\r\n    \"Tissue_malnutrition_Smoking\":form.Tissue_malnutrition_Smoking\r\n\t},\r\n\r\n\"Neurological_deficit\":{\t\t\r\n\t\"Neurological_deficit_Diabetes_MS_CVA\":form.Neurological_deficit_Diabetes_MS_CVA, \r\n    \"Neurological_deficit_Motor_sensory_deficit\":form.Neurological_deficit_Motor_sensory_deficit,\r\n    \"Neurological_deficit_Paraplegia\":form.Neurological_deficit_Paraplegia,\r\n\t\"Neurological_deficit_Combined_neurological_deficit\":form.Neurological_deficit_Combined_neurological_deficit\r\n\t},\r\n\t\r\n\"Major_surgery_or_trauma\":{\r\n\t\"Major_surgery_or_trauma_Orthopaedic_spinal\":form.Major_surgery_or_trauma_Orthopaedic_spinal,\r\n    \"Major_surgery_or_trauma_duration_of_surgery\":form.Major_surgery_or_trauma_duration_of_surgery,\r\n    \"Major_surgery_or_trauma_Major_Surgery_Or_Trauma_In_The_Last_48_Hours\":form.Major_surgery_or_trauma_Major_Surgery_Or_Trauma_In_The_Last_48_Hours\r\n},\r\n    \r\n\"Medication\":{\t\r\n\t\"Medication_Cytotoxics\":form.Medication_Cytotoxics,\r\n    \"Medication_Steroids\":form.Medication_Steroids,\r\n    \"Medication_Anti_inflammatories\":form.Medication_Anti_inflammatories, \r\n\t\"Medication_Combined_medication_risk\":form.Medication_Combined_medication_risk\r\n\t},\r\n    \r\n\"Sex_Age\":{\r\n    \"sex\":form.sex,\r\n\t\"age_group\":form.age_group,\r\n},\r\n\t\r\n\"Continence\":form.Continence,\r\n\r\n\"Mobility\":form.Mobility,\r\n\r\n\"Scoring_and_Grading\":{\r\n\t\"Waterlow_score\":form.Waterlow_score,\r\n\t\"Overall_risk_grade\":form.Overall_risk_grade,\r\n\t\"ScoringComment\":form.ScoringComment}\r\n\r\n});\r\n            }\r\n        })\r\n    };\r\n\r\n    var result = {};\r\n    Ehr.allhash(promises, function (res) {\r\n        result = res['forms'];\r\n    });\r\n\r\n    return result;\r\n}"}]}
{"name":"taunton-integration::falls-risk","category":"view","description":"Falls widget","metaData":"{\r\n    \"parameters\": [{\r\n          \"name\": \"dateFrom\",\r\n          \"type\": \"string\",\r\n          \"description\": \"Date From\"\r\n      }]\r\n}","steps":[{"processorName":"js","processorData":"// Falls Widget v1.0.1\r\n// HW - 1.0.1 - return null if dateFrom not provided\r\n\r\nfunction compute(ctx, src) {\r\n    var promises = {\r\n        fallsRisk: Ehr.query({\r\n            aql: \"SELECT \" +\r\n                \"a_a/data[at0002]/items[at0014]/value/value as fallsRiskResult, \" +\r\n                \"a_a/data[at0002]/items[at0014]/value/defining_code/code_string as fallsRiskResultCode, \" +\r\n                \"c/name/value as templateName, \" +\r\n                \"c/archetype_details/template_id/value as templateId, \" +\r\n                \"c/uid/value as compositionUid, \" +\r\n                \"c/context/start_time/value as dateCompositionSubmitted, \" +\r\n                \"c/composer/name as creator \\n \" +\r\n            \"FROM EHR e[ehr_id/value=:ehrId] \\n \" +\r\n            \"CONTAINS COMPOSITION c \\n \" +\r\n            \"CONTAINS EVALUATION a_a[openEHR-EHR-EVALUATION.patient_falls_risk.v0] \\n \" +\r\n            \"WHERE dateCompositionSubmitted > :dateFrom\\n\"+\r\n            \"ORDER BY dateCompositionSubmitted DESC\\n \" +\r\n            \"LIMIT 1\",\r\n            initvalue: [],\r\n            params: {\r\n              ehrId: ctx.vars.ehrId,\r\n              dateFrom: ctx.vars.dateFrom\r\n            },\r\n            callback: function(out, result) {\r\n                out.push(result);\r\n            }\r\n        })\r\n    };\r\n\r\n    function evaluate(assessment) {\r\n        var riskClass, riskText, referenceRange;\r\n        if (assessment.fallsRiskResultCode === null || assessment.fallsRiskResultCode === undefined) {\r\n            return null;\r\n        }\r\n        if (assessment.fallsRiskResultCode == 'at0015') {\r\n            riskClass = 'lr';\r\n        } else if (assessment.fallsRiskResultCode == 'at0016') {\r\n            riskClass = 'lmr';\r\n        }\r\n        return {\r\n            'compositionUid': (assessment.compositionUid.split(\"::\"))[0],\r\n            'riskText': assessment.fallsRiskResult,\r\n            'composer': assessment.creator,\r\n            'class': riskClass,\r\n            'date': assessment.dateCompositionSubmitted\r\n        };\r\n    }\r\n\r\n    var latestValue;\r\nif(ctx.vars.dateFrom) {\r\n    Ehr.allhash(promises, function (res) {\r\n        if (res['fallsRisk'] != undefined && res['fallsRisk'].length != 0)  {\r\n            if (res['fallsRisk'].length) {\r\n                latestValue = evaluate(res['fallsRisk'][0]);\r\n            } else {\r\n                latestValue = evaluate(res['fallsRisk']);\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n     return latestValue ? {\r\n        'widgetType': 'RISK_STAGE',    // RISK_STAGE | LIST_OF_FORMS | SINGLE_PARAMETER;\r\n        'riskStageType': 'SCORE',\r\n        'titleShort': 'Falls Risk',\r\n        'titleLong': 'Falls Risk',\r\n        'iconSrc': null,\r\n        'moreButtonUrl': null,\r\n        'clickUrl': null,\r\n        'latestValue': latestValue,\r\n    } : null;\r\n}"}]}
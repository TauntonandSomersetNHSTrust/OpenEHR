{"name":"assessments::waterlow-widget","category":"view","description":"Waterlow Assessment Widget","metaData":"{\r\n    \"parameters\": [\r\n        {\r\n            \"name\": \"ehrId\",\r\n            \"description\": \"Ehr id\",\r\n            \"type\": \"string\"\r\n        },\r\n      {\r\n          \"name\": \"dateFrom\",\r\n          \"type\": \"string\",\r\n          \"description\": \"Date From\"\r\n      }\r\n    ]\r\n}","steps":[{"processorName":"js","processorData":"// Assessments Waterlow Widget View v1.0.2\r\n// Template required: \"Waterlow pressure damage risk assessment\" v1.0.0\r\n// HW: 1.0.2 - return null if dateFrom not provided\r\n\r\nfunction compute(ctx, src)\r\n{\r\n    var promises = {\r\n        waterlowAssessment: Ehr.query({\r\n            aql: \"select\\n\"+\r\n            \"    c/composer/name as composer,\\n\"+\r\n            \"    c/context/start_time/value as dateCompositionSubmitted,\\n\"+\r\n            \"    waterlow_score/data[at0001]/origin/value as dateTime,\\n\"+\r\n            \"    waterlow_score/data[at0001]/events[at0002]/data[at0003]/items[at0014]/value/magnitude as waterlowScore,\\n\"+\r\n            \"    waterlow_score/data[at0001]/events[at0002]/data[at0003]/items[at0015]/value/value as riskGrade,\\n\"+\r\n            \"    waterlow_score/data[at0001]/events[at0002]/data[at0003]/items[at0015]/value/symbol/value as riskGradeDiscription,\\n\"+\r\n            \"    c/name/value as templateName,\\n\"+\r\n            \"    c/archetype_details/template_id/value as templateId,\\n\"+\r\n            \"    c/uid/value as compositionUid   \\n\"+\r\n            \"from EHR e [ehr_id/value=:ehrId]\\n\"+\r\n            \"contains COMPOSITION c\\n\"+\r\n            \"contains (\\n\"+\r\n            \"    OBSERVATION waterlow_score[openEHR-EHR-OBSERVATION.waterlow_score.v0])\\n\"+\r\n            \"where\\n\"+\r\n            \"    c/name/value='Waterlow pressure damage risk assessment'\\n\"+\r\n            \"AND dateCompositionSubmitted > :dateFrom\\n\"+\r\n            \"order by dateCompositionSubmitted desc\\n\"+\r\n            \"limit 8\",\r\n            initvalue: [],\r\n            params: {\r\n              ehrId: ctx.vars.ehrId,\r\n              dateFrom: ctx.vars.dateFrom\r\n            },\r\n            callback: function(out, result) {\r\n                out.push(result);\r\n            }\r\n        })\r\n    };\r\n\r\n    function evaluate(assessment) {\r\n        var riskClass, riskText, referenceRange, sparklineLevel;\r\n        if (assessment.waterlowScore === null || assessment.waterlowScore === undefined) {\r\n            return null;\r\n        }\r\n        if (assessment.waterlowScore <= 0) {\r\n            riskClass = \"lr\";\r\n            // riskText = \"Low risk\";\r\n            sparklineLevel = 0;\r\n            referenceRange = '= 0';\r\n        } else if (assessment.waterlowScore <= 9) {\r\n            riskClass = \"lr\";\r\n            // riskText = \"Low risk\";\r\n            sparklineLevel = 0;\r\n            referenceRange = '1 - 9';\r\n        } else if (assessment.waterlowScore <= 14) {\r\n            riskClass = \"lmr\";\r\n            riskText = \"At risk\";\r\n            sparklineLevel = 1;\r\n            referenceRange = '10 - 14';\r\n        } else if (assessment.waterlowScore <= 19) {\r\n            riskClass = \"mr\";\r\n            riskText = \"High risk\";\r\n            sparklineLevel = 0;\r\n            referenceRange = '15 - 19';\r\n        } else {\r\n            riskClass = \"hr\";\r\n            riskText = \"Very high risk\";\r\n            sparklineLevel = 0;\r\n            referenceRange = '20 - 64';\r\n        }\r\n        return {\r\n            'compositionUid': (assessment.compositionUid.split(\"::\"))[0],\r\n            'value': assessment.waterlowScore,\r\n            'date': assessment.dateCompositionSubmitted,\r\n            'composer': assessment.composer,\r\n            'class': riskClass,\r\n            'sparklineLevel': sparklineLevel,\r\n            'riskText': riskText,\r\n            'referenceRange': referenceRange\r\n        };\r\n    }\r\n\r\n    var latestValue;\r\n    var historicValues = [];\r\nif(ctx.vars.dateFrom) {\r\n    Ehr.allhash(promises, function(res) {\r\n        if (res['waterlowAssessment'] == null || res['waterlowAssessment'].length == 0) {\r\n            latestValue = null;\r\n        } else {\r\n            latestValue = evaluate(res['waterlowAssessment'][0]);\r\n            // res['waterlowAssessment'].shift();\r\n            historicValues = res['waterlowAssessment'];\r\n            historicValues = historicValues.map(evaluate).slice(1, 6); // Wrap this in try-catch\r\n            historicValues.unshift(latestValue);\r\n        }\r\n    });\r\n}\r\n    var moreButtonUrl = null;\r\n    var clickUrl = null;\r\n    if (latestValue != null) {\r\n        moreButtonUrl = {\r\n            'path': 'timeline/assessments::waterlow-timeline',\r\n            'navigationType': 'PORTAL'\r\n        };\r\n        clickUrl = {\r\n            'path': '' + latestValue.compositionUid,\r\n            'navigationType': 'PORTAL'\r\n        };\r\n    }\r\n\r\n    return latestValue ? {\r\n        'widgetType': 'RISK_STAGE',                 // RISK_STAGE | LIST_OF_FORMS | SINGLE_PARAMETER;\r\n        'riskStageType': 'SCORE',                   // SCORE | ASSESSMENT\r\n        'titleShort': 'Waterlow',\r\n        'titleLong': 'Waterlow Pressure Damage Risk',\r\n        'sparkline': {\r\n            levels: 1,\r\n            normalLevel: 0\r\n        },\r\n        'iconSrc': null,\r\n        'moreButtonUrl': moreButtonUrl,\r\n        'clickUrl': null,\r\n        'latestValue': latestValue,\r\n        'historicValues': historicValues\r\n    } : null;\r\n}\r\n"}]}
{"name":"PBIDashboards::Waterlow_Optimised","category":"view","description":"Waterlow View For PowerBi Dashboards (24-02-2021)","metaData":"{\r\n    \"parameters\": [\r\n        {\r\n            \"name\": \"last_x_days\",\r\n            \"description\": \"The last X days to show, or 365 if null\",\r\n            \"type\": \"string\"\r\n        }\r\n    ]\r\n}","steps":[{"processorName":"js","processorData":"// v1.0.0 - Haydn Williams - original\r\n// v1.0.1 - Haydn Williams - refactor to avoid bug using TOP 1 Composition\r\n// v1.0.2 - Haydn Williams - Increased default last_x_days to 365 and added global parameter\r\n// v1.0.3 - Haydn Williams - Optimisations to getRecentCompositionsAQL and getLatestFormDataAQL, setting returned data to null if none found, so discarded\r\n\r\nvar ehrIDReplace = \"<ehrid>\";\r\nvar LASTXDAYS = 365;\r\n\r\nvar replaceMe = \"<replace_date>\";\r\nvar cuid = \"<replace_cuid>\";\r\nvar formName = \"Waterlow pressure damage risk assessment\";\r\n\r\nvar getRecentCompositionsAQL = \"select DISTINCT e/ehr_id/value as ehr_id \" +\r\n\t\"FROM EHR e  \" +\r\n\t\"contains COMPOSITION a[openEHR-EHR-COMPOSITION.encounter.v1]  \\n\" + \r\n\t\"WHERE a/name/value = '\" + formName + \"' \" + \r\n\t\"AND a/context/start_time/value > '\" + replaceMe + \"' \" +\r\n\t\"ORDER BY a/context/start_time/value DESC \" + \r\n\t\"LIMIT 1000000000\";\r\n\t\r\nvar getLatestFormDataAQL = \"select \\n\" + \r\n    \"a/name/value as formName, \\n\" + \r\n\t\"e/ehr_status/subject/external_ref/id/value as mrn, \\n\" + \r\n    \"a/context/start_time/value as created, \\n\" + \r\n    \"e/ehr_status/subject/external_ref/id/value as mrn, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.body_weight.v2]/data[at0002]/events[at0003]/data[at0001]/items[at0004]/value as Weight, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.height.v2]/data[at0001]/events[at0002]/data[at0003]/items[at0004]/value as Height, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.body_mass_index.v2]/data[at0001]/events[at0002]/data[at0003]/items[at0004]/value as BMI, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0129]/items[at0054]/value/value as Nutritional_risk_Weight_loss, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0129]/items[at0044]/value/value as Nutritional_risk_Appetite, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0129]/items[at0130]/value as Nutritional_risk_Nutritional_score, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0116]/value/value as Skin_type_visual_risk_areas_Healthy, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0117]/value/value as Skin_type_visual_risk_areas_Tissue_paper, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0118]/value/value as Skin_type_visual_risk_areas_Dry, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0119]/value/value as Skin_type_visual_risk_areas_Oedematous, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0120]/value/value as Skin_type_visual_risk_areas_Clammy_pyrexia, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0121]/value/value as Skin_type_visual_risk_areas_Discoloured_Category_1, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0122]/value/value as Skin_type_visual_risk_areas_Pressure_ulcer_Stage_2_4, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0066]/items[at0164]/value/value as Skin_type_visual_risk_areas_Broken_spots_Category_2_4, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0070]/items[at0123]/value/value as Tissue_malnutrition_Terminal_cachexia, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0070]/items[at0124]/value/value as Tissue_malnutrition_Single_organ_failure_respiratory_renal_cardiac_liver, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0070]/items[at0125]/value/value as Tissue_malnutrition_Multiple_organ_failure, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0070]/items[at0126]/value/value as Tissue_malnutrition_Peripheral_vascular_disease, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0070]/items[at0127]/value/value as Tissue_malnutrition_Anaemia, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0070]/items[at0128]/value/value as Tissue_malnutrition_Smoking, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0073]/items[at0150]/value/value as Neurological_deficit_Diabetes_MS_CVA, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0073]/items[at0151]/value/value as Neurological_deficit_Motor_sensory_deficit, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0073]/items[at0152]/value/value as Neurological_deficit_Paraplegia, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0073]/items[at0135]/value/value as Neurological_deficit_Combined_neurological_deficit, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0068]/items[at0114]/value/value as Major_surgery_or_trauma_Orthopaedic_spinal, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0068]/items[at0144]/value/value as Major_surgery_or_trauma_duration_of_surgery, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0068]/items[at0156]/value/value as Major_surgery_or_trauma_Major_Surgery_Or_Trauma_In_The_Last_48_Hours, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0067]/items[at0106]/value/value as Medication_Cytotoxics, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0067]/items[at0107]/value/value as Medication_Steroids, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0067]/items[at0108]/value/value as Medication_Anti_inflammatories, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0067]/items[at0140]/value/value as Medication_Combined_medication_risk, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0008]/value/value as sex, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0009]/value/value as age_group, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0004]/value/value as Build_weight_for_height, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0005]/value/value as Continence, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0007]/value/value as Mobility, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0014]/value/magnitude as Waterlow_score, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0015]/value as Overall_risk_grade, \\n\" + \r\n    \"a/content[openEHR-EHR-OBSERVATION.waterlow_score.v0]/data[at0001]/events[at0002]/data[at0003]/items[at0019]/value as ScoringComment  \\n\" + \r\n\"from EHR e \\n\" + \r\n\"contains COMPOSITION a[openEHR-EHR-COMPOSITION.encounter.v1]  \\n\" + \r\n\t\"WHERE a/name/value = '\" + formName + \"' \" + \r\n\t\"AND e/ehr_id/value = '\" + ehrIDReplace + \"' \" +\r\n\t\"ORDER BY a/context/start_time/value DESC \" + \r\n\t\"LIMIT 1\";\r\n\t\r\nfunction generateEhrQuery(aql, params) {\r\n    return Ehr.query({\r\n        aql: aql,\r\n        initvalue: [],\r\n        params: params,\r\n        callback: function(out, result) {\r\n            out.push(result);\r\n        }\r\n    });\r\n}\t\r\n\t\r\nfunction getFromDate(ctx) {\r\n\tvar x = 365;\r\n\tif(ctx && ctx.vars){\r\n\t\tx = ctx.vars.last_x_days;\r\n\t\tif(!x || x == \"\") {\r\n\t\t\tx = ctx.vars.last_x_days = 365;\r\n\t\t}\r\n\t}\r\n\t\r\n\tvar oldDate = null;\r\n\tvar d = new Date();\r\n\toldDate = new Date(d.setDate(d.getDate() - x));\r\n\treturn oldDate.toISOString();\r\n}\r\n\r\nfunction getLatestComposition(ehr_id) {\r\n\tvar forms = null;\r\n\tvar promises = {\r\n\t\tcomposition: generateEhrQuery(\r\n\t\t\tgetLatestFormDataAQL.replace(ehrIDReplace, ehr_id), \r\n\t\t\t{}\r\n\t\t)\r\n\t};\r\n\tEhr.allhash(promises, function (res) {\r\n\t\tvar form = res.composition[0];\r\n\t\tforms = {\r\n\t\t\t\"formName\": form.formName,\r\n\t\t\t\"recordedDate\": form.created, \r\n\t\t\t\"PatientMRN\": form.mrn,\r\n\t\t\t\"NutritionalRisk\": { \r\n\t\t\t\"Weight\": {\r\n\t\t\t\t\"magnitude\": form.Weight.magnitude, \r\n\t\t\t\t\"units\": form.Weight.units\r\n\t\t\t\t}, \r\n\t\t\t\"Height\": {\r\n\t\t\t\t\"magnitude\": form.Height.magnitude,\r\n\t\t\t\t\"units\": form.Height.units\r\n\t\t\t\t}, \r\n\t\t\t\"BMI\": {\r\n\t\t\t\t\"magnitude\": form.BMI.magnitude,\r\n\t\t\t\t\"units\": form.BMI.units\r\n\t\t\t\t},\r\n\t\t\t\"Build_weight_for_height\":form.Build_weight_for_height,\r\n\t\t\t\"WeightLossScore\": form.Nutritional_risk_Weight_loss\r\n\t\t\t},\r\n\t\t\t\"Skin_type\":{\r\n\t\t\t\t\"Skin_type_Healthy\": form.Skin_type_visual_risk_areas_Healthy,\r\n\t\t\t\t\"Skin_type_Tissue_paper\": form.Skin_type_visual_risk_areas_Tissue_paper,\r\n\t\t\t\t\"Skin_type_Dry\": form.Skin_type_visual_risk_areas_Dry,\r\n\t\t\t\t\"Skin_type_Oedematous\": form.Skin_type_visual_risk_areas_Oedematous,\r\n\t\t\t\t\"Skin_type_Clammy_pyrexia\": form.Skin_type_visual_risk_areas_Clammy_pyrexia,\r\n\t\t\t\t\"Skin_type_Discoloured_Category_1\": form.Skin_type_visual_risk_areas_Discoloured_Category_1,\r\n\t\t\t\t\"Skin_type_Pressure_ulcer_Stage_2_4\": form.Skin_type_visual_risk_areas_Pressure_ulcer_Stage_2_4,\r\n\t\t\t\t\"Skin_type_Broken_spots_Category_2_4\": form.Skin_type_visual_risk_areas_Broken_spots_Category_2_4\r\n\t\t\t},\r\n\t\t\t\"Tissue_malnutrition\":{\r\n\t\t\t\t\r\n\t\t\t\t\"Tissue_malnutrition_Terminal_cachexia\":form.Tissue_malnutrition_Terminal_cachexia, \r\n\t\t\t\t\"Tissue_malnutrition_Single_organ_failure_respiratory_renal_cardiac_liver\":form.Tissue_malnutrition_Single_organ_failure_respiratory_renal_cardiac_liver, \r\n\t\t\t\t\"Tissue_malnutrition_Multiple_organ_failure\":form.Tissue_malnutrition_Multiple_organ_failure, \r\n\t\t\t\t\"Tissue_malnutrition_Peripheral_vascular_disease\":form.Tissue_malnutrition_Peripheral_vascular_disease, \r\n\t\t\t\t\"Tissue_malnutrition_Anaemia\":form.Tissue_malnutrition_Anaemia,\r\n\t\t\t\t\"Tissue_malnutrition_Smoking\":form.Tissue_malnutrition_Smoking\r\n\t\t\t},\r\n\t\t\t\"Neurological_deficit\":{\t\t\r\n\t\t\t\t\"Neurological_deficit_Diabetes_MS_CVA\":form.Neurological_deficit_Diabetes_MS_CVA, \r\n\t\t\t\t\"Neurological_deficit_Motor_sensory_deficit\":form.Neurological_deficit_Motor_sensory_deficit,\r\n\t\t\t\t\"Neurological_deficit_Paraplegia\":form.Neurological_deficit_Paraplegia,\r\n\t\t\t\t\"Neurological_deficit_Combined_neurological_deficit\":form.Neurological_deficit_Combined_neurological_deficit\r\n\t\t\t},\t\r\n\t\t\t\"Major_surgery_or_trauma\":{\r\n\t\t\t\t\"Major_surgery_or_trauma_Orthopaedic_spinal\": form.Major_surgery_or_trauma_Orthopaedic_spinal,\r\n\t\t\t\t\"Major_surgery_or_trauma_duration_of_surgery\":form.Major_surgery_or_trauma_duration_of_surgery,\r\n\t\t\t\t\"Major_surgery_or_trauma_Major_Surgery_Or_Trauma_In_The_Last_48_Hours\":form.Major_surgery_or_trauma_Major_Surgery_Or_Trauma_In_The_Last_48_Hours\r\n\t\t\t},\r\n\t\t\t\"Medication\":{\t\r\n\t\t\t\t\"Medication_Cytotoxics\":form.Medication_Cytotoxics,\r\n\t\t\t\t\"Medication_Steroids\":form.Medication_Steroids,\r\n\t\t\t\t\"Medication_Anti_inflammatories\":form.Medication_Anti_inflammatories, \r\n\t\t\t\t\"Medication_Combined_medication_risk\":form.Medication_Combined_medication_risk\r\n\t\t\t},    \r\n\t\t\t\"Sex_Age\":{\r\n\t\t\t\t\"sex\":form.sex,\r\n\t\t\t\t\"age_group\":form.age_group,\r\n\t\t\t},\r\n\t\t\t\"Continence\":form.Continence,\r\n\t\t\t\"Mobility\":form.Mobility,\r\n\t\t\t\"Scoring_and_Grading\":{\r\n\t\t\t\t\"Waterlow_score\":form.Waterlow_score,\r\n\t\t\t\t\"Overall_risk_grade\":form.Overall_risk_grade,\r\n\t\t\t\t\"ScoringComment\":form.ScoringComment\r\n\t\t\t}\r\n\t\t};\r\n\t});\r\n\treturn forms;\r\n}\r\n\t\r\nfunction getRecentCompositions(ctx) {\r\n\tvar fromDate = ''\r\n\tvar dateException = null;\r\n\t\r\n\ttry {\r\n\t\tfromDate = ctx.vars.from_date = getFromDate(ctx);\r\n\t} catch(ex) {\r\n\t\tdateException = ex;\r\n\t}\r\n\t\r\n\tvar query = getRecentCompositionsAQL.replace(replaceMe, fromDate);\r\n\r\n\tvar forms = [];\r\n\tvar promises = {\r\n\t\tcompositions: generateEhrQuery(query, {})\r\n\t};\r\n\t\r\n\ttry {\r\n\t\tEhr.allhash(promises, function (res) {\r\n\t\t\tfor(var i = 0; i < res.compositions.length; i++) {\r\n\t\t\t\tif(res.compositions[i].ehr_id) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tvar comp = getLatestComposition(res.compositions[i].ehr_id);\r\n\t\t\t\t\t\tif(comp) {\r\n\t\t\t\t\t\t\tforms.push(comp);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} catch(ex) {\r\n\t\t\t\t\t\tforms.push({\r\n\t\t\t\t\t\t\tmessage: 'Exception in second call',\r\n\t\t\t\t\t\t\tehr_id: res.compositions[i].ehr_id,\r\n\t\t\t\t\t\t\texception: ex.message\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\t\r\n\t\tvar parseISOString = function(s) {\r\n\t\t  var b = s.split(/\\D+/);\r\n\t\t  return new Date(Date.UTC(b[0], --b[1], b[2], b[3], b[4], b[5], b[6]));\r\n\t\t};\r\n\t\t\r\n\t\tforms.sort(function(a,b) {\t\t\t\r\n\t\t\tvar da = parseISOString(a.recordedDate).getTime();\r\n\t\t\tvar db = parseISOString(b.recordedDate).getTime();\r\n\t\t\t\r\n\t\t\treturn db-da; // reverse sort\r\n\t\t});\r\n\t\t\r\n\t} catch(ex) {\r\n\t\tforms.push({\r\n\t\t\tmessage: 'Exception in first call',\r\n\t\t\tdate_from: fromDate,\r\n\t\t\tquery: query,\r\n\t\t\texception: ex.message\r\n\t\t});\r\n\t}\r\n\t\r\n\treturn forms;\r\n\t\r\n}\r\n\r\nfunction compute(ctx, src) {\r\n\treturn getRecentCompositions(ctx);\r\n}"}]}
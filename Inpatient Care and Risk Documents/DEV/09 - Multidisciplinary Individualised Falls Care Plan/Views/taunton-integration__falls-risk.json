{"name":"taunton-integration::falls-risk","category":"view","description":"falls risk widget","metaData":"{\r\n    \"parameters\": [\r\n        {\r\n            \"name\": \"ehrId\",\r\n            \"description\": \"Ehr id\",\r\n            \"type\": \"string\"\r\n        },\r\n        {\r\n            \"name\": \"dateFrom\",\r\n            \"description\": \"Date from\",\r\n            \"type\": \"string\"\r\n        },\r\n        {\r\n            \"name\": \"dateTo\",\r\n            \"description\": \"Date to\",\r\n            \"type\": \"string\"\r\n        }\r\n    ]\r\n}","steps":[{"processorName":"js","processorData":"// Falls Risk Widget Section View v1.1.0\r\n// Template required: Falls care plan 1.0.0\r\n// Authors: Tomaz Kenda (tomaz.kenda@better.care), Vanessa Pereira (vanessa.pereira@better.care)\r\n\r\nfunction compute(ctx, src) {\r\n    var promises = {\r\n        fallsRisk: Ehr.query({\r\n            aql: \"SELECT \" +\r\n                \"a_a/data[at0002]/items[at0014]/value/value as fallsRiskResult, \" +\r\n                \"a_a/data[at0002]/items[at0014]/value/defining_code/code_string as fallsRiskResultCode, \" +\r\n                \"c/name/value as templateName, \" +\r\n                \"c/archetype_details/template_id/value as templateId, \" +\r\n                \"c/uid/value as compositionUid, \" +\r\n                \"c/context/start_time/value as dateCompositionSubmitted, \" +\r\n                \"c/archetype_details/template_id/value as templateId, \" +\r\n                \"c/composer/name as creator \\n \" +\r\n            \"FROM EHR e[ehr_id/value=:ehrId] \\n \" +\r\n            \"CONTAINS COMPOSITION c \\n \" +\r\n            \"CONTAINS EVALUATION a_a[openEHR-EHR-EVALUATION.patient_falls_risk.v0] \\n \" +\r\n            \"WHERE \\n\" +\r\n          \"templateId = 'Falls care plan' \\n\" +\r\n          (typeof (ctx.vars.dateFrom) === \"undefined\" || ctx.vars.dateFrom === null ?  '' : '    AND dateCompositionSubmitted >= :dateFrom') +\r\n            (typeof (ctx.vars.dateTo) === \"undefined\" || ctx.vars.dateTo === null ? '' : '    AND dateCompositionSubmitted <= :dateTo') +\r\n                \"\\n\"+\r\n            \"ORDER BY dateCompositionSubmitted DESC\\n \" +\r\n            \"LIMIT 1\",\r\n                initvalue: [],\r\n                params: ctx.vars,\r\n             callback: function(out, result) {\r\n                out.push(result);\r\n            }\r\n        })\r\n    };\r\n\r\n    function evaluate(assessment) {\r\n        var riskClass, riskText, referenceRange;\r\n        if (assessment.fallsRiskResultCode === null || assessment.fallsRiskResultCode === undefined) {\r\n            return null;\r\n        }\r\n        if (assessment.fallsRiskResultCode == 'at0015') {\r\n            riskClass = 'lr';\r\n        } else if (assessment.fallsRiskResultCode == 'at0016') {\r\n            riskClass = 'lmr';\r\n        }\r\n        return {\r\n            'compositionUid': (assessment.compositionUid.split(\"::\"))[0],\r\n            'riskText': assessment.fallsRiskResult,\r\n            'composer': assessment.creator,\r\n            'class': riskClass,\r\n            'date': assessment.dateCompositionSubmitted\r\n        };\r\n    }\r\n\r\n    var latestValue;\r\n    Ehr.allhash(promises, function (res) {\r\n        if (res['fallsRisk'] != undefined && res['fallsRisk'].length != 0)  {\r\n            if (res['fallsRisk'].length) {\r\n                latestValue = evaluate(res['fallsRisk'][0]);\r\n            } else {\r\n                latestValue = evaluate(res['fallsRisk']);\r\n            }\r\n        }\r\n    });\r\n\r\n     return latestValue ? {\r\n        'widgetType': 'RISK_STAGE',    // RISK_STAGE | LIST_OF_FORMS | SINGLE_PARAMETER;\r\n        'riskStageType': 'SCORE',\r\n        'titleShort': 'Falls Risk',\r\n        'titleLong': 'Falls Risk',\r\n        'iconSrc': null,\r\n        'moreButtonUrl': null,\r\n        'clickUrl': null,\r\n        'latestValue': latestValue,\r\n    } : null;\r\n}"}]}
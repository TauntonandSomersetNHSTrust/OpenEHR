{"name":"BCP::PatientFormData","category":"view","description":"Basic data on form completion for patients in case of Business Continuity Event (09-12-2020)","metaData":"{\r\n  \"parameters\": [\r\n      {\r\n          \"name\": \"ehrId\",\r\n          \"type\": \"string\",\r\n          \"description\": \"Ehr id\"\r\n      }\r\n  ]\r\n}","steps":[{"processorName":"js","processorData":"// v1.0.0 - UAT candidate\r\n// v1.0.1 - Diabetes Referral value fix\r\n// v1.0.2 - Waterlow and Must scores corrected to return magnitude, not value; getValueOrEmpty() corrected to return 0 when value of 0 is presented, not ''\r\n// v1.0.3 - Some AQL statements weren't sorting by start_date DESC, so returning first composition\r\n// v1.0.4 - Added more indept equipment examination for moving and handling\r\n// v1.0.5 - Removed TOP 1, and limited all queries to LIMIT 1. TOP 1 would return the first compostion of THE DAY\r\n\r\nvar ehrIDReplace = \"<ehrid>\";\r\n\t\t\r\nvar highAQL = \"SELECT c/context/start_time/value as high_completed \" +\r\n\t\t\"FROM EHR e \" + \r\n\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\"CONTAINS EVALUATION i[openEHR-EHR-EVALUATION.generic_assessment_collection.v0] \" +\r\n\t\t\"WHERE c/name/value = 'High Impact Risk Assessment' \" +\r\n\t\t\"AND e/ehr_id/value = '<ehrid>' \" +\r\n\t\t\"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\"OFFSET 0 LIMIT 1\";\r\n\r\nvar aboutAQL = \"SELECT c/context/start_time/value as about_completed \" +\r\n\t\t\"FROM EHR e \" + \r\n\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\"CONTAINS EVALUATION i[openEHR-EHR-EVALUATION.generic_assessment_collection.v0] \" +\r\n\t\t\"WHERE c/name/value = 'About Me' \" +\r\n\t\t\"AND e/ehr_id/value = '<ehrid>' \" +\r\n\t\t\"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\"OFFSET 0 LIMIT 1\";\r\n\r\nvar bodyAQL = \"SELECT c/context/start_time/value as body_completed \" +\r\n\t\t\"FROM EHR e \" + \r\n\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\"CONTAINS EVALUATION i[openEHR-EHR-EVALUATION.generic_assessment_collection.v0] \" +\r\n\t\t\"WHERE c/name/value = 'Body Map' \" +\r\n\t\t\"AND e/ehr_id/value = '<ehrid>' \" +\r\n\t\t\"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\"OFFSET 0 LIMIT 1\";\r\n\t\t\r\nvar waterlowAQL = \"SELECT y/data[at0001]/events[at0002]/data[at0003]/items[at0015]/value/value as waterlow_risk, \" +\r\n\t\t\t\t\t\t   \"y/data[at0001]/events[at0002]/data[at0003]/items[at0014]/value/magnitude as waterlow_score, \" +\r\n\t\t\t\t\t\t   \"c/context/start_time/value as waterlow_completed \" +\r\n\t\t\t\t\t\"FROM EHR e \" +\r\n\t\t\t\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\t\t\t\"CONTAINS OBSERVATION y[openEHR-EHR-OBSERVATION.waterlow_score.v0] \" +\r\n\t\t\t\t\t\"WHERE e/ehr_id/value = '<ehrid>' \" +\r\n\t\t                        \"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\t\t\t\t\t\r\nvar diabetesAQL = \"SELECT q/data[at0001]/items[at0028]/items[at0029]/value/value as diabetic_diabetes, \" +\r\n\t\t\t\t\t\t\"q/data[at0001]/items[at0031]/value/value as diabetic_referral, \" +\r\n\t\t\t\t\t\t\"c/context/start_time/value as diabetic_completed \" +\r\n\t\t\t\t\t\"FROM EHR e \" +\r\n\t\t\t\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\t\t\t\"CONTAINS EVALUATION q[openEHR-EHR-EVALUATION.paitent_diabetes_foot_screening.v0] \" +\r\n\t\t\t\t\t\"WHERE e/ehr_id/value = '<ehrid>' \" +\r\n\t\t                        \"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\t\t\t\t\t\r\nvar ccpAQL = \"SELECT a/data[at0001]/events[at0002]/data[at0003]/items[at0004]/items[at0005]/value/value as core_risk, \" +\r\n\t\t\t\t\"c/context/start_time/value as core_completed \" +\r\n\t\t\t\"FROM EHR e \" +\r\n\t\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\t\"CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.ulcer_prevention_management.v0]  \" +\r\n\t\t\t\"WHERE e/ehr_id/value = '<ehrid>' \" +\r\n\t\t        \"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\t\t\t\r\nvar mustAQL = \"SELECT q/data[at0001]/events[at0002]/data[at0003]/items[at0016]/value/value as must_risk, \" +\r\n\t\t\t\t\t   \"q/data[at0001]/events[at0002]/data[at0003]/items[at0015]/value/magnitude as must_score, \" +\r\n\t\t\t\t\t   \"c/context/start_time/value as must_completed \" +\r\n\t\t\t\t\"FROM EHR e \" +\r\n\t\t\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\t\t\"CONTAINS OBSERVATION q[openEHR-EHR-OBSERVATION.must.v0] \" +\r\n\t\t\t\t\"WHERE e/ehr_id/value = '<ehrid>' \" +\r\n\t\t                \"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\t\t\t\t\r\nvar fallsAQL = \"SELECT k/data[at0002]/items[at0014]/value/value as falls_risk, \" +\r\n\t\t\t\t\t   \"c/context/start_time/value as falls_completed \" +\r\n\t\t\t\t\"FROM EHR e \" +\r\n\t\t\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\t\t\"CONTAINS EVALUATION k[openEHR-EHR-EVALUATION.patient_falls_risk.v0]  \" +\r\n\t\t\t\t\"WHERE e/ehr_id/value = '<ehrid>' \" +\r\n\t\t                \"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\t\t\t\t\r\nvar movingAQL = \"SELECT c/context/start_time/value as moving_completed, \" +\r\n\t\t\"f/data[at0001]/items[at0015]/value/value as moving_risk, \" +\r\n\t\t\"f/data[at0001]/items[at0014]/value/value as moving_independent, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Moving Up or Down the bed']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_moving_up_down, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Rolling or Turning In Bed']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_rolling, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Sitting Up In Bed']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_sitting_up, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Sitting In Bed/Side Lying to/from Edge Sitting']/items[at0049]/items[at0028]/items[at0043]/name/value) as \t\tequip_sitting, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Bed to Bed']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_bed_to_bed, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Sit to/from Stand (Chair, Commode, Or Toilet)']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_sit_stand, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Seated To Seated Transfer (Chair, Commode, or Toilet)']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_seat_to_seat, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Walking']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_walk, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Emergency Handling']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_emergency \" +\r\n\t\t\"FROM EHR e \" +\r\n\t\t\"CONTAINS COMPOSITION c[openEHR-EHR-COMPOSITION.encounter.v1] \" +\r\n\t\t\"CONTAINS EVALUATION f[openEHR-EHR-EVALUATION.patient_handling.v0] \" +\r\n\t\t\"WHERE c/name/value = 'Moving and Handling Assessment and Care Plan'\" +\r\n\t\t\"AND e/ehr_id/value = '<ehrid>'\" +\r\n\t\t\"ORDER BY c/context/start_time/value DESC \" +\r\n\t\t\"LIMIT 1;\";\r\n\r\nvar railsAQL = \"SELECT u/data[at0001]/events[at0002]/data[at0003]/items[at0009]/items[at0019]/value/value as rails_guidance, \" +\r\n\t\t\t\t\t   \"c/context/start_time/value as rails_completed \" +\r\n\t\t\t\t\"FROM EHR e \" +\r\n\t\t\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\t\t\"CONTAINS OBSERVATION u[openEHR-EHR-OBSERVATION.bed_rails_low_bed_risk_assessment.v0]  \" +\r\n\t\t\t\t\"WHERE e/ehr_id/value = '<ehrid>' \" +\r\n\t\t                \"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\r\nfunction getValueOrEmpty(val) {\r\n    if(val != null) {\r\n        return val;\r\n    }\r\n    return '';\r\n}\r\n\r\n\r\nfunction processHighRisk(ehrid, baseQuery, results) {\r\n\tvar query = highAQL;\r\n\tbaseQuery.aql = query.replace(ehrIDReplace, ehrid);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.high_risk = {\r\n\t\t\tcompleted: form.high_completed\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processAboutMe(ehrid, baseQuery, results) {\r\n\tvar query = aboutAQL;\r\n\tbaseQuery.aql = query.replace(ehrIDReplace, ehrid);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.about_me = {\r\n\t\t\tcompleted: form.about_completed\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {});\r\n\treturn results;\r\n}\r\n\r\nfunction processBodyMap(ehrid, baseQuery, results) {\r\n\tvar query = bodyAQL;\r\n\tbaseQuery.aql = query.replace(ehrIDReplace, ehrid);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.body_map = {\r\n\t\t\tcompleted: form.body_completed\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processWaterlow(ehrid, baseQuery, results) {\r\n\tvar query = waterlowAQL;\r\n\tbaseQuery.aql = query.replace(ehrIDReplace, ehrid);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.waterlow = {\r\n\t\t\tcompleted: form.waterlow_completed,\r\n\t\t\trisk: getValueOrEmpty(form.waterlow_risk),\r\n\t\t\tscore: getValueOrEmpty(form.waterlow_score)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processDiabetes(ehrid, baseQuery, results) {\r\n\tvar query = diabetesAQL;\r\n\tbaseQuery.aql = query.replace(ehrIDReplace, ehrid);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.diabetic_foot = {\r\n\t\t\tcompleted: form.diabetic_completed,\r\n\t\t\thas_diabetes: getValueOrEmpty(form.diabetic_diabetes),\r\n\t\t\treferral: getValueOrEmpty(form.diabetic_referral) \r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processCCP(ehrid, baseQuery, results) {\r\n\tvar query = ccpAQL;\r\n\tbaseQuery.aql = query.replace(ehrIDReplace, ehrid);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.core_care_plan = {\r\n\t\t\tcompleted: form.core_completed,\r\n\t\t\trisk: getValueOrEmpty(form.core_risk)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processMUST(ehrid, baseQuery, results) {\r\n\tvar query = mustAQL;\r\n\tbaseQuery.aql = query.replace(ehrIDReplace, ehrid);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.must = {\r\n\t\t\tcompleted: form.must_completed,\r\n\t\t\trisk: getValueOrEmpty(form.must_risk),\r\n\t\t\tscore: getValueOrEmpty(form.must_score)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processFalls(ehrid, baseQuery, results) {\r\n\tvar query = fallsAQL;\r\n\tbaseQuery.aql = query.replace(ehrIDReplace, ehrid);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.falls = {\r\n\t\t\tcompleted: form.falls_completed,\r\n\t\t\trisk: getValueOrEmpty(form.falls_risk)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction isEmptyOrNoneRequired(equipment) {\r\n\tif(!equipment || equipment.length == 0) {\r\n\t\treturn true;\r\n\t}\r\n\t\r\n\tfor(var i = 0; i < equipment.length; i++) {\r\n\t\tif(!equipment[i].toLowerCase().startsWith('none')) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn true;\r\n}\t\r\n\r\nfunction processMovingEquipment(form) {\r\n\tvar result = 'None';\r\n\t\r\n\tvar equipArrays = [form.equip_bed_to_bed, \r\n\t\t\t\t\t\tform.equip_emergency,\r\n\t\t\t\t\t\tform.equip_moving_up_down,\r\n\t\t\t\t\t\tform.equip_rolling,\r\n\t\t\t\t\t\tform.equip_seat_to_seat,\r\n\t\t\t\t\t\tform.equip_sit_stand,\r\n\t\t\t\t\t\tform.equip_sitting,\r\n\t\t\t\t\t\tform.equip_sitting_up,\r\n\t\t\t\t\t\tform.equip_walk];\r\n\t\r\n\tfor(var i = 0; i < equipArrays.length; i++) {\r\n\t\tif(!isEmptyOrNoneRequired(equipArrays[i])) {\r\n\t\t\treturn 'Yes';\r\n\t\t}\r\n\t}\r\n\t\t\r\n\treturn result;\r\n}\r\n\r\nfunction processMoving(ehrid, baseQuery, results) {\r\n\tvar query = movingAQL;\r\n\tbaseQuery.aql = query.replace(ehrIDReplace, ehrid);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.moving_and_handling = {\r\n\t\t\tcompleted: form.moving_completed,\r\n\t\t\tequipment: processMovingEquipment(form),\r\n\t\t\tequipment_breakdown: {\r\n\t\t\t\tbed_to_bed: form.equip_bed_to_bed, \r\n\t\t\t\temergency: form.equip_emergency,\r\n\t\t\t\tmoving_up: form.equip_moving_up_down,\r\n\t\t\t\trolling: form.equip_rolling,\r\n\t\t\t\tseat_to_seat: form.equip_seat_to_seat,\r\n\t\t\t\tsit_stand: form.equip_sit_stand,\r\n\t\t\t\tsitting: form.equip_sitting,\r\n\t\t\t\tsitting_up: form.equip_sitting_up,\r\n\t\t\t\twalk: form.equip_walk\r\n\t\t\t},\r\n\t\t\tindependent: getValueOrEmpty(form.moving_independent),\r\n\t\t\trisk: getValueOrEmpty(form.moving_risk)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processRails(ehrid, baseQuery, results) {\r\n\tvar query = railsAQL;\r\n\tbaseQuery.aql = query.replace(ehrIDReplace, ehrid);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.rails = {\r\n\t\t\tcompleted: form.rails_completed,\r\n\t\t\tguidance: getValueOrEmpty(form.rails_guidance)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\n\r\nfunction compute(ctx, src) {\r\n\tvar ehrid = ctx.vars.ehrId;\r\n\tif(!ehrid) {\r\n\t\tthrow new Error('No EHRID supplied');\r\n\t}\r\n\t\r\n\ttry {\r\n\t\tvar results = {};\r\n\t\tvar baseQuery = {\r\n\t\t\taql: '',\r\n\t\t\tparams: ctx.vars,\r\n\t\t\tinitvalue: [],\r\n\t\t\tcallback: null\r\n\t\t};\r\n\t\t\r\n\t\tvar procs = [processHighRisk, processAboutMe, processBodyMap,\r\n\t\t\t\t\t\tprocessWaterlow, processDiabetes, processCCP, \r\n\t\t\t\t\t\tprocessMUST, processFalls, processMoving,\r\n\t\t\t\t\t\tprocessRails];\r\n\t\t\t\t\t\t\r\n\t\tfor(var i = 0; i < procs.length; i++) {\r\n\t\t\tresults = procs[i](ehrid, baseQuery, results);\r\n\t\t}\r\n\t\t\r\n\t\treturn results;\r\n\t} catch(ex) {\r\n\t\tthrow new Error('exceptiion!')\r\n\t}\r\n}"}]}
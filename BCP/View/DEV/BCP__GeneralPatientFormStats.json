{"name":"BCP::GeneralPatientFormStats","category":"view","description":"Returns completed form data on patient provided - 07-06-2021","metaData":"{\r\n  \"parameters\": [{\r\n          \"name\": \"ehrId\",\r\n          \"type\": \"string\",\r\n          \"description\": \"Ehr id\"\r\n      },{\r\n          \"name\": \"encounter_id\",\r\n          \"type\": \"string\",\r\n          \"description\": \"Encounter ID\"\r\n      }\r\n  ]\r\n}","steps":[{"processorName":"js","processorData":"// v1.0.0 - Haydn Williams - First version. Get diabetic result from latest About Me and Diabetic foot forms, return most recent of the two\r\n\r\n\r\nvar getLatestAQL = \t\"SELECT z/data[at0001]/items[at0028]/items[at0029]/value/value as diabetes_type_df, \" +\r\n\t\t\t\t\t\"r/data[at0001]/items[at0006]/items[openEHR-EHR-CLUSTER.generic_assessment.v0,'Nutrition and Hydration']/items[at0009]/items[at0013,'Diabetes Type']/value/value as diabetes_type_am, \" +\r\n\t\t\t\t\t\"e/ehr_id/value as ehrId, \" +\r\n\t\t\t\t\t\"c/context/start_time/value as completed \" +\r\n\t\t\t\t\"FROM EHR e \" +\r\n\t\t\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\t\t\"CONTAINS (EVALUATION z[openEHR-EHR-EVALUATION.paitent_diabetes_foot_screening.v0] OR CLUSTER r[openEHR-EHR-EVALUATION.generic_assessment_collection.v0]) \" +\r\n\t\t\t\t\"where ehrId = :ehrId \" +\r\n\t\t\t\t\"ORDER BY completed DESC \" +\r\n\t\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\r\nfunction getValueOrEmpty(val) {\r\n    if(val != null) {\r\n        return val;\r\n    }\r\n    return '';\r\n}\r\n\r\nfunction isEmptyOrNoneRequired(equipment) {\r\n\tif(!equipment || equipment.length == 0) {\r\n\t\treturn true;\r\n\t}\r\n\t\r\n\tfor(var i = 0; i < equipment.length; i++) {\r\n\t\tif(!equipment[i].toLowerCase().startsWith('none')) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn true;\r\n}\r\n\r\nfunction compute(ctx, src) {\r\n\tvar ehr_id = ctx.vars.ehrId;\r\n\t\r\n\tif(!ehr_id) {\r\n\t\tthrow new Error('No ehr_id supplied');\r\n\t}\r\n\t\r\n\tvar results = {\r\n\t\tfound: false\r\n\t};\r\n\t\r\n\tvar baseQuery = {\r\n\t\taql: getLatestAQL,\r\n\t\tparams: {\r\n\t\t\tehrId: ehr_id\r\n\t\t},\r\n\t\tinitvalue: [],\r\n\t\tcallback: function(out, form) {\r\n\t\t\tvar found = false;\r\n\t\t\tvar diaType = ''\r\n\t\t\tvar sourceForm = '';\r\n\t\t\tif(!form.diabetes_type_am) {\r\n\t\t\t\tdiaType = form.diabetes_type_df;\r\n\t\t\t\tsourceForm = 'Diabetic Foot'\r\n\t\t\t} else {\r\n\t\t\t\tdiaType = form.diabetes_type_am;\r\n\t\t\t\tsourceForm = 'About Me'\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif(!diaType) \r\n\t\t\t{\r\n\t\t\t\tsourceForm = diaType = '';\r\n\t\t\t}\r\n\t\t\telse found = true;\r\n\t\t\r\n\t\t\tresults = {\r\n\t\t\t\tfound: found,\r\n\t\t\t\tsource: sourceForm,\r\n\t\t\t\tdiabetes_type: diaType,\r\n\t\t\t\traw_am: form.diabetes_type_am,\r\n\t\t\t\traw_df: form.diabetes_type_df,\r\n\t\t\t\tcompleted: form.completed\r\n\t\t\t};\r\n\t\t} \r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}"}]}
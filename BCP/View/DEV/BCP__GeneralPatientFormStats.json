{"name":"BCP::GeneralPatientFormStats","category":"view","description":"Returns completed form data on patient provided - 07-06-2021","metaData":"{\r\n  \"parameters\": [{\r\n          \"name\": \"ehrId\",\r\n          \"type\": \"string\",\r\n          \"description\": \"Ehr id\"\r\n      },{\r\n          \"name\": \"encounter_id\",\r\n          \"type\": \"string\",\r\n          \"description\": \"Encounter ID\"\r\n      }\r\n  ]\r\n}","steps":[{"processorName":"js","processorData":"// v1.0.0 - development build\r\n// v1.0.1 - swiched to Encounter ID, rather than Limit 1 of enhr_id\r\n// v1.0.2 - 18-05-2021 - HW - reimplemented ehr id to subset data\r\n// v1.0.3 - 18-05-2021 - HW - removed most AQL not used by BCP. Thereforre branched to BCP::GeneralPatientFormStats\r\n\r\nvar encounterIDReplace = \"<encounter_id>\";\r\n\r\nvar highAQL = \"SELECT c/context/start_time/value as high_completed, \" +\r\n\t\"c/context/other_context/items[openEHR-EHR-CLUSTER.encounter_context.v0, 'Encounter Context']/items[at0002]/value as encounter_id \" + \r\n\t\"FROM EHR e [ehr_id/value=:ehrId] \"+\r\n\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\"WHERE c/name/value = 'High Impact Risk Assessment' \" +\r\n\t\t\"AND encounter_id = '\" + encounterIDReplace + \"' \" +\r\n\t\t\"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\"OFFSET 0 LIMIT 1\";\r\n\r\nvar aboutAQL = \"SELECT c/context/start_time/value as about_completed, \" +\r\n\t\"c/context/other_context/items[openEHR-EHR-CLUSTER.encounter_context.v0, 'Encounter Context']/items[at0002]/value as encounter_id \" + \r\n\t\t\"FROM EHR e [ehr_id/value=:ehrId] \"+\r\n\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\"WHERE c/name/value = 'About Me' \" +\r\n\t\t\"AND encounter_id = '\" + encounterIDReplace + \"' \" +\r\n\t\t\"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\"OFFSET 0 LIMIT 1\";\r\n\r\nvar bodyAQL = \"SELECT c/context/start_time/value as body_completed, \" +\r\n\t\t\"c/context/other_context/items[openEHR-EHR-CLUSTER.encounter_context.v0, 'Encounter Context']/items[at0002]/value as encounter_id \" +\r\n\t\t\"FROM EHR e [ehr_id/value=:ehrId] \"+\r\n\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\"WHERE c/name/value = 'Body Map' \" +\r\n\t\t\"AND encounter_id = '\" + encounterIDReplace + \"' \" +\r\n\t\t\"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\"OFFSET 0 LIMIT 1\";\r\n\t\t\r\nvar waterlowAQL = \"SELECT i/data[at0001]/events[at0002]/data[at0003]/items[at0015]/value/value as waterlow_risk, \" +\r\n\t\t\t\t\t\t   \"i/data[at0001]/events[at0002]/data[at0003]/items[at0014]/value/magnitude as waterlow_score, \" +\r\n\t\t\t\t\t\t   \"c/context/start_time/value as waterlow_completed, \" +\r\n\t\t\t\t\t\t\t\"c/context/other_context/items[openEHR-EHR-CLUSTER.encounter_context.v0, 'Encounter Context']/items[at0002]/value as encounter_id \" + \r\n\t\t\t\t\t\"FROM EHR e [ehr_id/value=:ehrId] \"+\r\n\t\t\t\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\t\t\t\"CONTAINS OBSERVATION i[openEHR-EHR-OBSERVATION.waterlow_score.v0] \" +\r\n\t\t\t\t\t\"WHERE encounter_id = '\" + encounterIDReplace + \"' \" +\r\n\t\t            \"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\t\t\t\t\t\r\nvar diabetesAQL = \"SELECT q/data[at0001]/items[at0028]/items[at0029]/value/value as diabetic_diabetes, \" +\r\n\t\t\t\t\t\t\"q/data[at0001]/items[at0031]/value/value as diabetic_referral, \" +\r\n\t\t\t\t\t\t\"c/context/start_time/value as diabetic_completed, \" +\r\n\t\t\t\t\t\t\"c/context/other_context/items[openEHR-EHR-CLUSTER.encounter_context.v0, 'Encounter Context']/items[at0002]/value as encounter_id \" + \r\n\t\t\t\t\t\"FROM EHR e [ehr_id/value=:ehrId] \"+\r\n\t\t\t\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\t\t\t\"CONTAINS EVALUATION q[openEHR-EHR-EVALUATION.paitent_diabetes_foot_screening.v0] \" +\r\n\t\t\t\t\t\"WHERE encounter_id = '\" + encounterIDReplace + \"' \" +\r\n\t\t                        \"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\t\t\t\t\t\r\nvar ccpAQL = \"SELECT a/data[at0001]/events[at0002]/data[at0003]/items[at0004]/items[at0005]/value/value as core_risk, \" +\r\n\t\t\t\t\"c/context/start_time/value as core_completed, \" +\r\n\t\t\t\t\"c/context/other_context/items[openEHR-EHR-CLUSTER.encounter_context.v0, 'Encounter Context']/items[at0002]/value as encounter_id \" + \r\n\t\t\t\"FROM EHR e [ehr_id/value=:ehrId] \"+\r\n\t\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\t\"CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.ulcer_prevention_management.v0] \" +\r\n\t\t\t\"WHERE encounter_id = '\" + encounterIDReplace + \"' \" +\r\n\t\t        \"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\t\t\t\r\nvar mustAQL = \"SELECT q/data[at0001]/events[at0002]/data[at0003]/items[at0016]/value/value as must_risk, \" +\r\n\t\t\t\t\t   \"q/data[at0001]/events[at0002]/data[at0003]/items[at0015]/value/magnitude as must_score, \" +\r\n\t\t\t\t\t\t\"c/context/start_time/value as must_completed, \" +\t\t\r\n\t\t\t\t\t\t\"c/context/other_context/items[openEHR-EHR-CLUSTER.encounter_context.v0, 'Encounter Context']/items[at0002]/value as encounter_id \" + \r\n\t\t\t\t\"FROM EHR e [ehr_id/value=:ehrId] \"+\r\n\t\t\t\t\"CONTAINS COMPOSITION c  \" +\r\n\t\t\t\t\"CONTAINS OBSERVATION q[openEHR-EHR-OBSERVATION.must.v0] \" +\r\n\t\t\t\t\"WHERE encounter_id = '\" + encounterIDReplace + \"' \" +\r\n\t\t                \"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\t\t\t\t\r\nvar fallsAQL = \"SELECT k/data[at0002]/items[at0014]/value/value as falls_risk, \" +\r\n\t\t\t\t\t   \"c/context/start_time/value as falls_completed, \" +\r\n\t\t\t\t\t\t\"c/context/other_context/items[openEHR-EHR-CLUSTER.encounter_context.v0, 'Encounter Context']/items[at0002]/value as encounter_id, \" + \r\n\t\t\t\t\"k/data[at0002]/items[at0013]/value/value as falls_risk_comment \" + \r\n\t\t\t\t\"FROM EHR e [ehr_id/value=:ehrId] \"+\r\n\t\t\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\t\t\"CONTAINS EVALUATION k[openEHR-EHR-EVALUATION.patient_falls_risk.v0] \" +\r\n\t\t\t\t\"WHERE encounter_id = '\" + encounterIDReplace + \"' \" +\r\n\t\t                \"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\t\t\t\t\r\nvar movingAQL = \"SELECT c/context/start_time/value as moving_completed, \" +\r\n\t\t\"c/context/other_context/items[openEHR-EHR-CLUSTER.encounter_context.v0, 'Encounter Context']/items[at0002]/value as encounter_id, \" + \r\n\t\t\r\n\t\t//general stuff\r\n\t\t\"f/data[at0001]/items[at0015]/value/value as moving_risk, \" +\r\n\t\t\"f/data[at0001]/items[at0014]/value/value as moving_independent, \" +\r\n\t\t\"f/data[at0001]/items[at0014]/value/value as moving_fully_independent, \" +\r\n\r\n\t\t//equipment\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Moving Up or Down the bed']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_moving_up_down, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Rolling or Turning In Bed']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_rolling, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Sitting Up In Bed']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_sitting_up, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Sitting In Bed/Side Lying to/from Edge Sitting']/items[at0049]/items[at0028]/items[at0043]/name/value) as \t\tequip_sitting, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Bed to Bed']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_bed_to_bed, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Sit to/from Stand (Chair, Commode, Or Toilet)']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_sit_stand, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Seated To Seated Transfer (Chair, Commode, or Toilet)']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_seat_to_seat, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Walking']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_walk, \" +\r\n\t\t\"SQUASH(f/data[at0001]/items[at0019]/items[at0020,'Moving and Handling Task - Emergency Handling']/items[at0049]/items[at0028]/items[at0043]/name/value) as equip_emergency \" +\r\n\r\n\t\t\"FROM EHR e [ehr_id/value=:ehrId] \"+\r\n\t\t\"CONTAINS COMPOSITION c[openEHR-EHR-COMPOSITION.encounter.v1] \" +\r\n\t\t\"CONTAINS EVALUATION f[openEHR-EHR-EVALUATION.patient_handling.v0] \" +\r\n\t\t\"WHERE c/name/value = 'Moving and Handling Assessment and Care Plan'\" +\r\n\t\t\"AND encounter_id = '\" + encounterIDReplace + \"' \" +\r\n\t\t\"ORDER BY c/context/start_time/value DESC \" +\r\n\t\t\"LIMIT 1;\";\r\n\t\r\nvar railsAQL = \"SELECT u/data[at0001]/events[at0002]/data[at0003]/items[at0009]/items[at0019]/value/value as rails_guidance, \" +\r\n\t\t\t\t\t   \"c/context/start_time/value as rails_completed, \" +\r\n\t\t\t\t\t\t\"c/context/other_context/items[openEHR-EHR-CLUSTER.encounter_context.v0, 'Encounter Context']/items[at0002]/value as encounter_id \" + \r\n\t\t\t\t\"FROM EHR e [ehr_id/value=:ehrId] \"+\r\n\t\t\t\t\"CONTAINS COMPOSITION c \" +\r\n\t\t\t\t\"CONTAINS OBSERVATION u[openEHR-EHR-OBSERVATION.bed_rails_low_bed_risk_assessment.v0] \" +\r\n\t\t\t\t\"WHERE encounter_id = '\" + encounterIDReplace + \"' \" +\r\n\t\t                \"ORDER BY c/context/start_time/value DESC  \" +\r\n\t\t\t\t\"OFFSET 0 LIMIT 1\";\r\n\r\nfunction getValueOrEmpty(val) {\r\n    if(val != null) {\r\n        return val;\r\n    }\r\n    return '';\r\n}\r\n\r\nfunction processHighRisk(encounter_id, baseQuery, results) {\r\n\tvar query = highAQL;\r\n\tbaseQuery.aql = query.replace(encounterIDReplace, encounter_id);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.high_risk = {\r\n\t\t\tencounter_id: encounter_id,\r\n\t\t\tcompleted: form.high_completed\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processAboutMe(encounter_id, baseQuery, results) {\r\n\tvar query = aboutAQL;\r\n\tbaseQuery.aql = query.replace(encounterIDReplace, encounter_id);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.about_me = {\r\n\t\t\tencounter_id: encounter_id,\r\n\t\t\tcompleted: form.about_completed\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {});\r\n\treturn results;\r\n}\r\n\r\nfunction processBodyMap(encounter_id, baseQuery, results) {\r\n\tvar query = bodyAQL;\r\n\tbaseQuery.aql = query.replace(encounterIDReplace, encounter_id);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.body_map = {\r\n\t\t\tencounter_id: encounter_id,\r\n\t\t\tcompleted: form.body_completed\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processWaterlow(encounter_id, baseQuery, results) {\r\n\tvar query = waterlowAQL;\r\n\tbaseQuery.aql = query.replace(encounterIDReplace, encounter_id);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.waterlow = {\r\n\t\t\tencounter_id: encounter_id,\r\n\t\t\tcompleted: form.waterlow_completed,\r\n\t\t\trisk: getValueOrEmpty(form.waterlow_risk),\r\n\t\t\tscore: getValueOrEmpty(form.waterlow_score)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processDiabetes(encounter_id, baseQuery, results) {\r\n\tvar query = diabetesAQL;\r\n\tbaseQuery.aql = query.replace(encounterIDReplace, encounter_id);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.diabetic_foot = {\r\n\t\t\tencounter_id: encounter_id,\r\n\t\t\tcompleted: form.diabetic_completed,\r\n\t\t\thas_diabetes: getValueOrEmpty(form.diabetic_diabetes),\r\n\t\t\treferral: getValueOrEmpty(form.diabetic_referral)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processCCP(encounter_id, baseQuery, results) {\r\n\tvar query = ccpAQL;\r\n\tbaseQuery.aql = query.replace(encounterIDReplace, encounter_id);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.core_care_plan = {\r\n\t\t\tencounter_id: encounter_id,\r\n\t\t\tcompleted: form.core_completed,\r\n\t\t\trisk: getValueOrEmpty(form.core_risk)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processMUST(encounter_id, baseQuery, results) {\r\n\tvar query = mustAQL;\r\n\tbaseQuery.aql = query.replace(encounterIDReplace, encounter_id);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.must = {\r\n\t\t\tencounter_id: encounter_id,\r\n\t\t\tcompleted: form.must_completed,\r\n\t\t\trisk: getValueOrEmpty(form.must_risk),\r\n\t\t\tscore: getValueOrEmpty(form.must_score)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processFalls(encounter_id, baseQuery, results) {\r\n\tvar query = fallsAQL;\r\n\tbaseQuery.aql = query.replace(encounterIDReplace, encounter_id);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.falls = {\r\n\t\t\tencounter_id: encounter_id,\r\n\t\t\tcompleted: form.falls_completed,\r\n\t\t\trisk: getValueOrEmpty(form.falls_risk)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\t\r\n\r\nfunction processMovingEquipment(form) {\r\n\tvar result = 'None';\r\n\t\r\n\tvar equipArrays = [form.equip_bed_to_bed, \r\n\t\t\t\t\t\tform.equip_emergency,\r\n\t\t\t\t\t\tform.equip_moving_up_down,\r\n\t\t\t\t\t\tform.equip_rolling,\r\n\t\t\t\t\t\tform.equip_seat_to_seat,\r\n\t\t\t\t\t\tform.equip_sit_stand,\r\n\t\t\t\t\t\tform.equip_sitting,\r\n\t\t\t\t\t\tform.equip_sitting_up,\r\n\t\t\t\t\t\tform.equip_walk];\r\n\t\r\n\tfor(var i = 0; i < equipArrays.length; i++) {\r\n\t\tif(!isEmptyOrNoneRequired(equipArrays[i])) {\r\n\t\t\treturn 'Yes';\r\n\t\t}\r\n\t}\r\n\t\t\r\n\treturn result;\r\n}\r\n\r\nfunction isEmptyOrNoneRequired(equipment) {\r\n\tif(!equipment || equipment.length == 0) {\r\n\t\treturn true;\r\n\t}\r\n\t\r\n\tfor(var i = 0; i < equipment.length; i++) {\r\n\t\tif(!equipment[i].toLowerCase().startsWith('none')) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn true;\r\n}\r\n\r\n\r\nfunction processMoving(encounter_id, baseQuery, results) {\r\n\tvar query = movingAQL;\r\n\tbaseQuery.aql = query.replace(encounterIDReplace, encounter_id);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.moving_and_handling = {\r\n\t\t\tencounter_id: encounter_id,\r\n\t\t\tcompleted: form.moving_completed,\r\n\t\t\tequipment: processMovingEquipment(form),\r\n\t\t\tindependent: getValueOrEmpty(form.moving_independent),\r\n\t\t\trisk: getValueOrEmpty(form.moving_risk)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\nfunction processRails(encounter_id, baseQuery, results) {\r\n\tvar query = railsAQL;\r\n\tbaseQuery.aql = query.replace(encounterIDReplace, encounter_id);\r\n\tbaseQuery.callback = function (out, form) {\r\n\t\tresults.rails = {\r\n\t\t\tencounter_id: encounter_id,\r\n\t\t\tcompleted: form.rails_completed,\r\n\t\t\tguidance: getValueOrEmpty(form.rails_guidance)\r\n\t\t};\r\n\t};\r\n\t\r\n\tEhr.allhash({forms: Ehr.query(baseQuery)}, function (res) {\t});\r\n\treturn results;\r\n}\r\n\r\n\r\nfunction compute(ctx, src) {\r\n\tvar encounter_id = ctx.vars.encounter_id;\r\n\tvar ehr_id = ctx.vars.ehrId;\r\n\t\r\n\tif(!encounter_id) {\r\n\t\tthrow new Error('No encounter_id supplied');\r\n\t}\r\n\t\r\n\tif(!ehr_id) {\r\n\t\tthrow new Error('No ehr_id supplied');\r\n\t}\r\n\t\r\n\t// try {\r\n\t\tvar results = {};\r\n\t\tvar baseQuery = {\r\n\t\t\taql: '',\r\n\t\t\tparams: {\r\n\t\t\t\tehrId: ehr_id,\r\n\t\t\t\tencounter_id: encounter_id\r\n\t\t\t},\r\n\t\t\tinitvalue: [],\r\n\t\t\tcallback: null\r\n\t\t};\r\n\t\t\r\n\t\tvar procs = [processHighRisk, processAboutMe, processBodyMap,\r\n\t\t\t\t\t\tprocessWaterlow, processDiabetes, processCCP, \r\n\t\t\t\t\t\tprocessMUST, processFalls, processMoving,\r\n\t\t\t\t\t\tprocessRails];\r\n\t\t\t\t\t\t\r\n\t\tfor(var i = 0; i < procs.length; i++) {\r\n\t\t\tresults = procs[i](encounter_id, baseQuery, results);\r\n\t\t}\r\n\t\t\r\n\t\treturn results;\r\n\t// } catch(ex) {\r\n\t//\tthrow new Error('exceptiion!: ' + ex.message + ex.stacktrace)\r\n\t// }\r\n}"}]}